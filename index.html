<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>‚ö° TRIDENT V5.0 - GLOBAL RADAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        /* ÊåáÈáùÊ®£Âºè */
        .win-pointer { width: 4px; height: 32px; background: #fff; position: absolute; top: -6px; transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: 0 0 15px #fff; z-index: 40; }
        .avg-pointer { width: 2px; height: 32px; background: rgba(255,255,255,0.6); position: absolute; top: -6px; transition: all 0.8s; border: 1px dashed #fff; z-index: 30; }
        .h1-pointer { width: 2px; height: 32px; background: #f59e0b; position: absolute; top: -6px; transition: all 1.2s; border: 1px dotted #f59e0b; z-index: 20; }
        .h4-pointer { width: 2px; height: 32px; background: #3b82f6; position: absolute; top: -6px; transition: all 1.5s; z-index: 10; }
        
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; transition: 0.5s all; }
        .signal-buy { border: 2px solid #10b981; }
        .signal-sell { border: 2px solid #ef4444; }
        .signal-hold { border: 2px solid #a855f7; box-shadow: 0 0 20px rgba(168,85,247,0.1); }
        .del-btn { opacity: 0; transition: 0.2s; position: absolute; top: 4px; right: 8px; z-index: 50; }
        .card-stat:hover .del-btn { opacity: 1; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body class="flex flex-col h-screen p-4">
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-2xl font-black text-white italic tracking-tighter">TRIDENT <span class="text-amber-500">V5.0</span></h1>
            <div id="scan-status" class="text-[10px] text-zinc-500 font-mono mt-1">Á≥ªÁµ±ÂïüÂãï‰∏≠...</div>
        </div>
        <div class="flex gap-4 text-right">
            <div class="text-[9px] leading-tight">
                <span class="text-blue-500">‚ñ† 4H Èï∑Á∑öÂ∞éËà™</span><br>
                <span class="text-amber-500">‚ñ† 1H ‰∏≠Á∑öÊîØÊíê</span>
            </div>
            <div class="text-[9px] leading-tight border-l border-zinc-800 pl-4">
                <span class="text-zinc-400">‚ñ° 5M Áü≠Á∑öÊÉÖÁ∑í</span><br>
                <span class="white">‚ñ° NOW Âç≥ÊôÇÂãïËÉΩ</span>
            </div>
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-y-auto pb-24"></div>

<script>
    // ÊéíÈô§ÂàóË°® (ÈªëÂêçÂñÆ)
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','DOGEUSDT','ADAUSDT','TRXUSDT','AVAXUSDT','SHIBUSDT','TONUSDT','LINKUSDT','DOTUSDT','NEARUSDT','MATICUSDT','BCHUSDT','LTCUSDT','ICPUSDT','UNIUSDT','LEOUSDT','ETCUSDT','XLMUSDT','BNXUSDT'];
    let marketData = {}; 
    let manualExcludes = new Set();
    let scanQueue = [];

    // 1. ÂàùÂßãÂåñÂñÆÂπ£ + Á≤æÊ∫ñÂõûÂ°´ (Âê´ 5M, 1H, 4H)
    async function initStream(symbol) {
        if (marketData[symbol] && marketData[symbol].isReady) return;
        
        let d4=0, d1=0, d5m=0;
        try {
            const k = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=240`).then(r=>r.json());
            k.forEach((v, i) => { 
                let d = parseFloat(v[10]) - (parseFloat(v[7]) - parseFloat(v[10])); // Taker Buy - (Total - Taker Buy)
                d4 += d; 
                if(i >= 180) d1 += d; 
                if(i >= 235) d5m += d; 
            });
        } catch(e) { console.error(`Failed fetching ${symbol}`); }

        const ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
        
        marketData[symbol] = { 
            symbol, 
            winRate: 50, 
            avgWinRate5m: 50 + (d5m / 500000 * 50), 
            avgWinRate1h: 50 + (d1 / 5000000 * 50), 
            avgWinRate4h: 50 + (d4 / 20000000 * 50),
            delta: d4, 
            lastPrice: 0, 
            maxDelta: 20000, 
            history5m: [], 
            hasActive: false, 
            isReady: true,
            ws: ws
        };

        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            const v = parseFloat(d.q) * parseFloat(d.p);
            if (v < 300) return; // ÈÅéÊøæÈõúË®ä
            
            let p = marketData[symbol];
            p.lastPrice = d.p;
            p.hasActive = true;
            
            // ÁÆóÊ≥ï‰øÆÊ≠£ÔºöÂãïÊÖãË°∞Ê∏õËàá Tanh ÈòªÂäõ
            p.delta = (p.delta * 0.9995) + (d.m ? -v : v);
            p.maxDelta = Math.max(p.maxDelta * 0.9999, Math.abs(p.delta), 20000);
            
            let ratio = p.delta / p.maxDelta;
            let smoothRatio = Math.tanh(ratio * 1.8); // Âº∑Âº±ÊúâÂ∫èÊ†∏ÂøÉ
            let t = 50 + (smoothRatio * 50);
            
            p.winRate = (p.winRate * 0.9) + (t * 0.1); // ÊÖ£ÊÄßÂπ≥Êªë
            
            // ÂÆöÊôÇÊõ¥Êñ∞Â§ßÈÄ±Êúü
            if(!p.t5 || Date.now()-p.t5 > 8000) { p.avgWinRate5m = (p.avgWinRate5m * 0.95) + (p.winRate * 0.05); p.t5=Date.now(); }
            if(!p.t1 || Date.now()-p.t1 > 30000) { p.avgWinRate1h = (p.avgWinRate1h * 0.98) + (p.winRate * 0.02); p.t1=Date.now(); }
            if(!p.t4 || Date.now()-p.t4 > 120000) { p.avgWinRate4h = (p.avgWinRate4h * 0.99) + (p.winRate * 0.01); p.t4=Date.now(); }
        };
    }

    // 2. ÂÖ®Â∏ÇÂ†¥Êº∏ÈÄ≤ÂºèÊéÉÊèè
    async function globalScan() {
        try {
            const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
            const allSymbols = tickers
                .filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol) && !manualExcludes.has(s.symbol))
                .sort((a,b) => (parseFloat(b.quoteVolume)*Math.abs(parseFloat(b.priceChangePercent))) - (parseFloat(a.quoteVolume)*Math.abs(parseFloat(a.priceChangePercent))));

            // ÂÑ™ÂÖàÈ°ØÁ§∫Ââç 20 Èöª
            const top20 = allSymbols.slice(0, 20);
            for(let s of top20) { await initStream(s.symbol); }

            // ÂæåÂè∞ÊÖ¢ÊÖ¢Ë∑ëÂâ©‰∏ãÁöÑ (ÊØèÁßí3Èöª)
            scanQueue = allSymbols.slice(20);
            processQueue();
        } catch(e) { console.error("Global scan failed"); }
    }

    async function processQueue() {
        if (scanQueue.length === 0) {
            document.getElementById('scan-status').innerText = "‚óè RADAR ACTIVE: ÂÖ®Â∏ÇÂ†¥ÊéÉÊèèÂÆåÊàê";
            return;
        }
        document.getElementById('scan-status').innerText = `‚óè ÂæåÂè∞Á≤æÁÆó‰∏≠: Ââ©È§ò ${scanQueue.length} Èöª`;
        let batch = scanQueue.splice(0, 3);
        await Promise.all(batch.map(s => initStream(s.symbol)));
        setTimeout(processQueue, 1000);
    }

    // 3. Âà™Èô§ÂäüËÉΩ
    function removeSymbol(s) {
        if(marketData[s]) {
            marketData[s].ws.close();
            delete marketData[s];
            manualExcludes.add(s);
            document.getElementById(`card-${s}`)?.remove();
        }
    }

    // 4. Ê∏≤ÊüìÈù¢Êùø
    function render() {
        const panel = document.getElementById('main-panel');
        // Âè™È°ØÁ§∫ÊúÄÂº∑ÁöÑ 20 Èöª
        const sortedKeys = Object.keys(marketData)
            .filter(s => marketData[s].hasActive)
            .sort((a,b) => marketData[b].winRate - marketData[a].winRate)
            .slice(0, 20);

        sortedKeys.forEach(s => {
            let item = marketData[s];
            let card = document.getElementById(`card-${s}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${s}`;
                panel.appendChild(card);
            }

            // ÁãÄÊÖãÂà§Êñ∑
            let isExploding = item.winRate > 90;
            let sigClass = isExploding ? 'signal-hold' : (item.winRate > item.avgWinRate5m + 2 ? 'signal-buy' : (item.winRate < item.avgWinRate5m - 2 ? 'signal-sell' : ''));
            let trendText = item.avgWinRate1h < item.avgWinRate4h ? '‚ö†Ô∏è ËΩâÂº±' : (isExploding ? 'üî• Âô¥Áôº' : '‚óè Áõ£Êéß');

            card.className = `card-stat p-4 rounded-lg ${sigClass} relative`;
            card.innerHTML = `
                <button onclick="removeSymbol('${s}')" class="del-btn text-zinc-600 hover:text-white font-bold text-lg">√ó</button>
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="font-black text-white italic text-lg leading-none tracking-tighter">${s.replace('USDT','')}</div>
                        <div class="text-[10px] text-zinc-500 mt-1 font-mono">$${parseFloat(item.lastPrice).toLocaleString()}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] font-bold ${item.winRate > 50 ? 'text-emerald-500' : 'text-red-500'}">
                            NOW: ${item.winRate.toFixed(1)}%
                        </div>
                        <div class="text-[9px] text-zinc-600 font-mono">1H:${item.avgWinRate1h.toFixed(1)}% | 4H:${item.avgWinRate4h.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="h-4 w-full win-gradient rounded-sm relative mb-4">
                    <div class="h4-pointer" style="left:${item.avgWinRate4h}%"></div>
                    <div class="h1-pointer" style="left:${item.avgWinRate1h}%"></div>
                    <div class="avg-pointer" style="left:${item.avgWinRate5m}%"></div>
                    <div class="win-pointer" style="left:${item.winRate}%"></div>
                </div>
                <div class="flex justify-between items-center text-[10px] font-black uppercase">
                    <div class="${item.avgWinRate1h < item.avgWinRate4h ? 'text-amber-500 blink' : 'text-zinc-500'}">${trendText}</div>
                    <div class="text-zinc-500 font-mono">POW: $${(Math.abs(item.delta)/1000).toFixed(1)}K</div>
                </div>
            `;
        });
    }

    // ÂïüÂãï
    globalScan();
    setInterval(render, 500);
    // ÊØè 10 ÂàÜÈêòÈáçÊñ∞Ê†°Ê∫ñÂÖ®Â∏ÇÂ†¥ÊéíÂ∫è
    setInterval(() => { scanQueue = []; globalScan(); }, 600000);
</script>
</body>
</html>
