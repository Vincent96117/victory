<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V2.7 - KINETIC HEAVY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        /* 增加指針平滑過度時間 */
        .win-pointer { width: 5px; height: 32px; background: #fff; position: absolute; top: -6px; transition: all 0.8s cubic-bezier(0.15, 0.5, 0.15, 1); box-shadow: 0 0 15px #fff; }
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; }
        .ghost-border { border: 1px solid #f59e0b; }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-black text-white italic italic">TRIDENT V2.7 <span class="text-xs font-normal text-zinc-500">重力穩定版</span></h1>
        <div class="flex gap-2">
            <input type="text" id="search-input" placeholder="搜尋..." class="bg-zinc-900 border border-zinc-800 rounded px-3 py-1 text-sm text-white outline-none">
            <button onclick="handleSearch()" class="bg-white text-black px-4 py-1 rounded font-bold text-sm">追蹤</button>
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-y-auto pb-24"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','DOGEUSDT','ADAUSDT','TRXUSDT','AVAXUSDT','SHIBUSDT','TONUSDT','LINKUSDT','DOTUSDT','NEARUSDT','MATICUSDT','BCHUSDT','LTCUSDT','ICPUSDT','UNIUSDT','LEOUSDT','ETCUSDT','XLMUSDT','BNXUSDT'];
    let marketData = {}; 
    let ghostSymbols = new Set();

    async function scanGhosts() {
        try {
            const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
            const sorted = data.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol))
                .sort((a, b) => (parseFloat(b.quoteVolume)*Math.abs(parseFloat(b.priceChangePercent))) - (parseFloat(a.quoteVolume)*Math.abs(parseFloat(a.priceChangePercent))))
                .slice(0, 16);
            ghostSymbols.clear();
            sorted.forEach(g => { ghostSymbols.add(g.symbol); initStream(g.symbol); });
        } catch(e) {}
    }

    function initStream(symbol) {
        if (marketData[symbol]) return;
        const ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
        marketData[symbol] = { symbol, winRate: 50, avgWinRate5m: 50, delta: 0, lastPrice: 0, maxDelta: 2000, historyWinRates: [], hasActive: false };

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const value = parseFloat(data.q) * parseFloat(data.p);
            const isSell = data.m;
            let pool = marketData[symbol];
            
            // 降噪核心：忽略極小單
            if (value < 200) return; 

            pool.lastPrice = parseFloat(data.p);
            pool.hasActive = true;

            // 累加 Delta
            pool.delta += isSell ? -value : value;
            
            // 修正分母邏輯：增加基礎厚度 (3000)，讓指針不再閃現
            pool.maxDelta = Math.max(pool.maxDelta * 0.9999, Math.abs(pool.delta), 3000);
            
            // 計算目標 winRate
            let target = 50 + ((pool.delta / pool.maxDelta) * 50);
            
            // 重力平滑：每次成交只影響 5% 的移動，這會讓指針變得很穩
            pool.winRate = (pool.winRate * 0.95) + (target * 0.05);

            if(!pool.lastT || Date.now() - pool.lastT > 10000) {
                pool.historyWinRates.push(pool.winRate);
                if(pool.historyWinRates.length > 30) pool.historyWinRates.shift();
                pool.avgWinRate5m = pool.historyWinRates.reduce((a,b)=>a+b,0) / pool.historyWinRates.length;
                pool.lastT = Date.now();
            }
        };
    }

    function render() {
        const panel = document.getElementById('main-panel');
        const sorted = Object.keys(marketData).filter(s => marketData[s].hasActive).sort((a,b) => ghostSymbols.has(b) - ghostSymbols.has(a));

        sorted.forEach(s => {
            let item = marketData[s];
            let card = document.getElementById(`card-${s}`);
            if (!card) { card = document.createElement('div'); card.id = `card-${s}`; panel.appendChild(card); }

            const trendUp = item.winRate > item.avgWinRate5m;
            card.className = `card-stat p-4 rounded-lg relative ${ghostSymbols.has(s) ? 'ghost-border' : ''}`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold text-white">${s.replace('USDT','')}</div>
                    <div class="text-right text-xs">
                        <div class="text-zinc-500">5M: ${item.avgWinRate5m.toFixed(1)}%</div>
                        <div class="text-lg font-black ${item.winRate > 50 ? 'text-emerald-500' : 'text-red-500'}">${item.winRate.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="h-4 w-full win-gradient rounded-sm relative mb-4">
                    <div class="win-pointer" style="left: ${item.winRate}%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-bold">
                    <div class="${trendUp ? 'text-emerald-400' : 'text-red-400'}">${trendUp ? '▲ STABLE BUY' : '▼ STABLE SELL'}</div>
                    <div class="text-zinc-500">POW: $${(Math.abs(item.delta)/1000).toFixed(1)}K</div>
                </div>
            `;
        });
    }

    function handleSearch() {
        const input = document.getElementById('search-input');
        const s = input.value.trim().toUpperCase();
        if (s) { initStream(s.endsWith('USDT')?s:s+'USDT'); input.value=''; }
    }

    scanGhosts();
    setInterval(scanGhosts, 20000); 
    setInterval(render, 800);
</script>
</body>
</html>
