<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT V5.6 - ZERO LAG RADAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        .win-pointer { width: 4px; height: 32px; background: #fff; position: absolute; top: -6px; transition: all 0.3s; box-shadow: 0 0 15px #fff; z-index: 40; }
        .avg-pointer { width: 2px; height: 32px; background: rgba(255,255,255,0.6); position: absolute; top: -6px; border: 1px dashed #fff; z-index: 30; }
        .h1-pointer { width: 2px; height: 32px; background: #f59e0b; position: absolute; top: -6px; border: 1px dotted #f59e0b; z-index: 20; }
        .h4-pointer { width: 2px; height: 32px; background: #3b82f6; position: absolute; top: -6px; z-index: 10; }
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; position: relative; }
        .signal-buy { border: 2px solid #10b981; }
        .signal-sell { border: 2px solid #ef4444; }
        .signal-hold { border: 2px solid #a855f7; box-shadow: 0 0 20px rgba(168,85,247,0.1); }
        .del-btn { opacity: 0; transition: 0.2s; position: absolute; top: 4px; right: 8px; z-index: 50; cursor: pointer; }
        .card-stat:hover .del-btn { opacity: 1; }
        #heartbeat { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .hb-active { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body class="flex flex-col h-screen p-4">
    <div class="flex justify-between items-start mb-4">
        <div class="flex items-center">
            <div id="heartbeat"></div>
            <div>
                <h1 class="text-xl font-black text-white italic leading-none">TRIDENT V5.6</h1>
                <p id="scan-status" class="text-[9px] text-zinc-500 font-mono mt-1 font-bold italic uppercase tracking-widest">Global Radar Active</p>
            </div>
        </div>
        <div class="flex flex-col items-end gap-2">
            <div class="flex gap-2">
                <button onclick="location.reload()" class="bg-red-900/40 hover:bg-red-600 border border-red-500 text-white text-[10px] px-2 py-1 rounded font-bold transition">☢ REBOOT</button>
                <input type="text" id="search-input" placeholder="SEARCH SYMBOL" class="bg-zinc-900 border border-zinc-700 text-[10px] px-2 py-1 rounded text-white focus:border-amber-500 outline-none w-28 uppercase">
                <button onclick="manualSearch()" class="bg-amber-600 hover:bg-amber-500 text-white text-[10px] px-3 py-1 rounded font-bold uppercase">Trace</button>
            </div>
            <div class="text-[8px] text-zinc-600 font-bold uppercase tracking-tighter">
                Manual: Priority | Auto: Top 20 Strength
            </div>
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-y-auto pb-24"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','DOGEUSDT','ADAUSDT','TRXUSDT','AVAXUSDT','SHIBUSDT','TONUSDT','LINKUSDT','DOTUSDT','NEARUSDT','MATICUSDT','BCHUSDT','LTCUSDT','ICPUSDT','UNIUSDT','LEOUSDT','ETCUSDT','XLMUSDT','BNXUSDT'];
    let marketData = {}; 
    let manualExcludes = new Set();
    let scanQueue = [];
    let lastHeartbeat = Date.now();

    // 1. 初始化與數據抓取 (核心改動：搜尋即時校準)
    async function initStream(symbol, isPriority = false) {
        // 如果是搜尋，強制重連以確保數據最新
        if (isPriority && marketData[symbol]) {
            if(marketData[symbol].ws) marketData[symbol].ws.close();
        } else if (marketData[symbol]?.ws) return;

        const cleanSymbol = symbol.toUpperCase().endsWith('USDT') ? symbol.toUpperCase() : symbol.toUpperCase() + 'USDT';
        
        try {
            // 三管齊下：價格、歷史、資費同步抓取
            const [ticker, k, f] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${cleanSymbol}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${cleanSymbol}&interval=1m&limit=240`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${cleanSymbol}`).then(r=>r.json())
            ]);

            let d4=0, d1=0, d5m=0;
            k.forEach((v, i) => { 
                let d = parseFloat(v[10]) - (parseFloat(v[7]) - parseFloat(v[10]));
                d4 += d; if(i >= 180) d1 += d; if(i >= 235) d5m += d;
            });

            const ws = new WebSocket(`wss://fstream.binance.com/ws/${cleanSymbol.toLowerCase()}@aggTrade`);
            
            marketData[cleanSymbol] = { 
                symbol: cleanSymbol, 
                winRate: 50, 
                avgWinRate5m: 50 + (d5m/500000*50), 
                avgWinRate1h: 50 + (d1/5000000*50), 
                avgWinRate4h: 50 + (d4/20000000*50),
                delta: d4, 
                lastPrice: ticker.price, // 搜尋當下立刻用 Ticker 價格填補
                maxDelta: 20000, 
                fundingRate: parseFloat(f.lastFundingRate)*100, 
                priority: isPriority, 
                isReady: true, 
                ws: ws, 
                lastUpdate: Date.now()
            };

            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                const v = parseFloat(d.q) * parseFloat(d.p);
                if (v < 350) return; // 過濾門檻微調
                
                lastHeartbeat = Date.now();
                let p = marketData[cleanSymbol];
                if(!p) return;
                
                p.lastPrice = d.p; // WebSocket 數據接手更新價格
                p.lastUpdate = Date.now();
                p.delta = (p.delta * 0.9995) + (d.m ? -v : v);
                p.maxDelta = Math.max(p.maxDelta * 0.9999, Math.abs(p.delta), 20000);
                let t = 50 + (Math.tanh((p.delta/p.maxDelta) * 1.8) * 50);
                p.winRate = (p.winRate * 0.9) + (t * 0.1);
                
                if(!p.t5 || Date.now()-p.t5>8000) { p.avgWinRate5m = (p.avgWinRate5m*0.9)+ (p.winRate*0.1); p.t5=Date.now(); }
                if(!p.t1 || Date.now()-p.t1>30000) { p.avgWinRate1h = (p.avgWinRate1h*0.98)+ (p.winRate*0.02); p.t1=Date.now(); }
                if(!p.t4 || Date.now()-p.t4>120000) { p.avgWinRate4h = (p.avgWinRate4h*0.99)+ (p.winRate*0.01); p.t4=Date.now(); }
            };
        } catch(e) { console.error(`${cleanSymbol} fetch failed`); }
    }

    // 2. 全市場掃描邏輯
    async function globalScan() {
        const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const all = tickers
            .filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol) && !manualExcludes.has(s.symbol))
            .sort((a,b) => (parseFloat(b.quoteVolume)*Math.abs(parseFloat(b.priceChangePercent))) - (parseFloat(a.quoteVolume)*Math.abs(parseFloat(a.priceChangePercent))));

        const top20 = all.slice(0, 20);
        const topSymbols = new Set(top20.map(t => t.symbol));

        // 清理非優先且不在前 20 的連線，保持輕量
        Object.keys(marketData).forEach(s => {
            if (!topSymbols.has(s) && !marketData[s].priority) {
                if(marketData[s].ws) marketData[s].ws.close();
                delete marketData[s];
            }
        });

        for(let s of top20) { await initStream(s.symbol); }
        scanQueue = all.slice(20);
        processQueue();
    }

    async function processQueue() {
        if (scanQueue.length === 0) { document.getElementById('scan-status').innerText = "RADAR: MONITORING ALL"; return; }
        document.getElementById('scan-status').innerText = `CALC: ${scanQueue.length} COINS IN STORAGE`;
        let batch = scanQueue.splice(0, 2);
        await Promise.all(batch.map(s => initStream(s.symbol)));
        setTimeout(processQueue, 2500); // 慢速背景輪詢
    }

    // 3. 介面操作
    function manualSearch() {
        const input = document.getElementById('search-input');
        const symbol = input.value.trim().toUpperCase();
        if (symbol) { initStream(symbol, true); input.value = ''; }
    }

    function removeSymbol(s) {
        if(marketData[s]) { 
            if(marketData[s].ws) marketData[s].ws.close(); 
            delete marketData[s]; 
            manualExcludes.add(s); 
            document.getElementById(`card-${s}`)?.remove(); 
        }
    }

    // 4. 渲染循環
    function render() {
        const panel = document.getElementById('main-panel');
        const sorted = Object.keys(marketData)
            .filter(s => marketData[s].isReady)
            .sort((a,b) => {
                if(marketData[a].priority && !marketData[b].priority) return -1;
                if(!marketData[a].priority && marketData[b].priority) return 1;
                return marketData[b].winRate - marketData[a].winRate;
            })
            .slice(0, 20);

        // 心跳燈
        const hb = document.getElementById('heartbeat');
        if (Date.now() - lastHeartbeat < 1500) { hb.className = 'hb-active'; } else { hb.className = ''; }

        sorted.forEach(s => {
            let item = marketData[s]; let card = document.getElementById(`card-${s}`);
            if (!card) { card = document.createElement('div'); card.id = `card-${s}`; panel.appendChild(card); }
            
            let isFundingHigh = Math.abs(item.fundingRate) >= 0.05;
            let sigClass = item.winRate > 90 ? 'signal-hold' : (item.winRate > item.avgWinRate5m+2 ? 'signal-buy' : (item.winRate < item.avgWinRate5m-2 ? 'signal-sell' : ''));
            
            card.className = `card-stat p-4 rounded-lg ${sigClass}`;
            card.innerHTML = `
                <div onclick="removeSymbol('${s}')" class="del-btn text-zinc-700 hover:text-white font-bold text-lg">×</div>
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-black text-white italic text-base leading-none">${s.replace('USDT','')}</div>
                        <div class="text-[9px] text-zinc-500 mt-1.5">$${parseFloat(item.lastPrice).toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                    </div>
                    <div class="text-right flex flex-col items-end leading-none">
                        <div class="flex gap-1 text-[7.5px] font-bold mb-1.5 uppercase opacity-80">
                            <span class="text-blue-500">4H:${item.avgWinRate4h.toFixed(1)}</span>
                            <span class="text-amber-500">1H:${item.avgWinRate1h.toFixed(1)}</span>
                            <span class="text-zinc-500">5M:${item.avgWinRate5m.toFixed(1)}</span>
                        </div>
                        <div class="text-xl font-black ${item.winRate>50?'text-emerald-500':'text-red-500'}">${item.winRate.toFixed(1)}%</div>
                        ${isFundingHigh ? `<div class="text-[8px] text-amber-500 font-bold blink mt-1">FUNDING ${item.fundingRate.toFixed(3)}%</div>` : ''}
                    </div>
                </div>
                <div class="h-4 w-full win-gradient rounded-sm relative mb-2 overflow-hidden border border-zinc-800">
                    <div class="h4-pointer" style="left:${item.avgWinRate4h}%"></div>
                    <div class="h1-pointer" style="left:${item.avgWinRate1h}%"></div>
                    <div class="avg-pointer" style="left:${item.avgWinRate5m}%"></div>
                    <div class="win-pointer" style="left:${item.winRate}%"></div>
                </div>
                <div class="flex justify-between items-center text-[9px] font-mono">
                    <div class="${item.avgWinRate1h < item.avgWinRate4h ? 'text-amber-500 font-bold blink' : 'text-zinc-600'}">
                        ${item.avgWinRate1h < item.avgWinRate4h ? '⚠️ WEAKENING' : '● MOMENTUM OK'}
                    </div>
                    <div class="text-zinc-500">POW: $${(Math.abs(item.delta)/1000).toFixed(1)}K</div>
                </div>`;
        });
        
        // 清理老舊 DOM
        Array.from(panel.children).forEach(child => {
            if (!sorted.includes(child.id.replace('card-',''))) child.remove();
        });
    }

    // 啟動與自動維護
    globalScan();
    setInterval(render, 1000); 
    setInterval(globalScan, 300000); // 5 分鐘清一次內存，確保不卡頓
    document.getElementById('search-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') manualSearch(); });
</script>
</body>
</html>
