<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ TRIDENT V4.0 - ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        /* NOW å¯¦ç·š (æœ€å¿«) */
        .win-pointer { width: 4px; height: 32px; background: #fff; position: absolute; top: -6px; transition: all 0.5s; box-shadow: 0 0 15px #fff; z-index: 40; }
        /* 5M è™›ç·š (å¿«) */
        .avg-pointer { width: 2px; height: 32px; background: rgba(255,255,255,0.6); position: absolute; top: -6px; transition: all 0.8s; border: 1px dashed #fff; z-index: 30; }
        /* 1H é»ç·š (ä¸­) */
        .h1-pointer { width: 2px; height: 32px; background: #f59e0b; position: absolute; top: -6px; transition: all 1.2s; border: 1px dotted #f59e0b; z-index: 20; }
        /* 4H å¯¦ç·šç´°é‡ (æ…¢) */
        .h4-pointer { width: 2px; height: 32px; background: #3b82f6; position: absolute; top: -6px; transition: all 1.5s; z-index: 10; }
        
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; position: relative; }
        .signal-buy { border: 2px solid #10b981; }
        .signal-sell { border: 2px solid #ef4444; }
        .signal-hold { border: 2px solid #a855f7; box-shadow: 0 0 20px rgba(168,85,247,0.2); }
        .del-btn { opacity: 0; transition: 0.2s; }
        .card-stat:hover .del-btn { opacity: 1; }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-black text-white italic">TRIDENT V4.0 <span class="text-xs font-normal text-zinc-500 uppercase">Ultimate Quad-Core</span></h1>
            <p class="text-[9px] text-zinc-600">ç™½å¯¦:NOW | ç™½è™›:5M | é»ƒé»:1H | è—å¯¦:4H | é»æ“Š Ã— åˆªé™¤ä¸¦è‡ªå‹•è£œå……</p>
        </div>
        <div class="flex gap-2">
            <input type="text" id="search-input" placeholder="æœå°‹..." class="bg-zinc-900 border border-zinc-800 rounded px-3 py-1 text-sm text-white outline-none w-32 focus:border-amber-500">
            <button onclick="handleSearch()" class="bg-white text-black px-4 py-1 rounded font-bold text-sm">è¿½è¹¤</button>
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-y-auto pb-24"></div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','DOGEUSDT','ADAUSDT','TRXUSDT','AVAXUSDT','SHIBUSDT','TONUSDT','LINKUSDT','DOTUSDT','NEARUSDT','MATICUSDT','BCHUSDT','LTCUSDT','ICPUSDT','UNIUSDT','LEOUSDT','ETCUSDT','XLMUSDT','BNXUSDT'];
    let marketData = {}; 
    let manualExcludes = new Set(); // å­˜æ”¾ä½¿ç”¨è€…é»æ“Šåˆªé™¤çš„å¹£ç¨®

    // 1. åˆå§‹åŒ–èˆ‡æ­·å²æ•¸æ“šæŠ“å–
    async function initStream(symbol) {
        if (marketData[symbol]) return;
        
        let delta4h = 0, delta1h = 0;
        try {
            const klines = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=240`).then(r=>r.json());
            klines.forEach((k, idx) => {
                const vol = parseFloat(k[7]);
                const taker = parseFloat(k[10]);
                const d = taker - (vol - taker);
                delta4h += d;
                if (idx >= 180) delta1h += d; // æœ€å¾Œ 60 ç­†æ˜¯ä¸€å°æ™‚
            });
        } catch(e) {}

        const ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
        marketData[symbol] = { 
            symbol, winRate: 50, avgWinRate5m: 50, avgWinRate1h: 50, avgWinRate4h: 50,
            delta: delta4h, lastPrice: 0, maxDelta: 15000, history5m: [], history1h: [], history4h: [],
            hasActive: false, signal: 'NEUTRAL', prevWinRate: 50
        };

        // åˆå§‹è³¦å€¼ (é¿å…æŒ‡é‡å¾ 0 é–‹å§‹)
        marketData[symbol].avgWinRate4h = 50 + ((delta4h / (15000 * 240)) * 50);
        marketData[symbol].avgWinRate1h = 50 + ((delta1h / (15000 * 60)) * 50);

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const value = parseFloat(data.q) * parseFloat(data.p);
            if (value < 300) return; 

            let pool = marketData[symbol];
            pool.lastPrice = parseFloat(data.p); pool.hasActive = true;
            pool.delta += data.m ? -value : value;
            pool.maxDelta = Math.max(pool.maxDelta * 0.99995, Math.abs(pool.delta), 15000);
            
            let target = 50 + ((pool.delta / pool.maxDelta) * 50);
            pool.prevWinRate = pool.winRate;
            pool.winRate = (pool.winRate * 0.97) + (target * 0.03);

            // 5M AVG
            if(!pool.lastT5 || Date.now() - pool.lastT5 > 8000) {
                pool.history5m.push(pool.winRate);
                if(pool.history5m.length > 40) pool.history5m.shift();
                pool.avgWinRate5m = pool.history5m.reduce((a,b)=>a+b,0) / pool.history5m.length;
                pool.lastT5 = Date.now();
            }
            // 1H AVG (30ç§’æ¡æ¨£)
            if(!pool.lastT1h || Date.now() - pool.lastT1h > 30000) {
                pool.history1h.push(pool.winRate);
                if(pool.history1h.length > 120) pool.history1h.shift();
                pool.avgWinRate1h = pool.history1h.reduce((a,b)=>a+b,0) / pool.history1h.length;
                pool.lastT1h = Date.now();
            }
            // 4H AVG (2åˆ†é˜æ¡æ¨£)
            if(!pool.lastT4h || Date.now() - pool.lastT4h > 120000) {
                pool.history4h.push(pool.winRate);
                if(pool.history4h.length > 120) pool.history4h.shift();
                pool.avgWinRate4h = pool.history4h.reduce((a,b)=>a+b,0) / pool.history4h.length;
                pool.lastT4h = Date.now();
            }

            const isEx = pool.winRate > 88;
            if (isEx && pool.winRate >= pool.prevWinRate) pool.signal = 'HOLD'; 
            else if (pool.winRate > pool.avgWinRate5m + 1.5) pool.signal = 'BUY'; 
            else if (pool.winRate < pool.avgWinRate5m - 1.2) pool.signal = 'SELL';
            else pool.signal = 'NEUTRAL';
        };
        marketData[symbol].ws = ws;
    }

    // 2. è‡ªå‹•æƒæèˆ‡æ›¿è£œ
    async function scan() {
        try {
            const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
            const sorted = data.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol) && !manualExcludes.has(s.symbol))
                .sort((a, b) => (parseFloat(b.quoteVolume)*Math.abs(parseFloat(b.priceChangePercent))) - (parseFloat(a.quoteVolume)*Math.abs(parseFloat(a.priceChangePercent))));
            
            // ç¢ºä¿é¢æ¿å§‹çµ‚æœ‰ 16 å€‹
            let count = 0;
            for (let item of sorted) {
                if (count >= 16) break;
                initStream(item.symbol);
                count++;
            }
        } catch(e) {}
    }

    // 3. åˆªé™¤é‚è¼¯
    function removeSymbol(s) {
        if (marketData[s]) {
            if(marketData[s].ws) marketData[s].ws.close();
            delete marketData[s];
            manualExcludes.add(s);
            const card = document.getElementById(`card-${s}`);
            if (card) card.remove();
            scan(); // ç«‹å³è£œä½
        }
    }

    function render() {
        const panel = document.getElementById('main-panel');
        const active = Object.keys(marketData).filter(s => marketData[s].hasActive);
        active.sort((a,b) => marketData[b].winRate - marketData[a].winRate).forEach(s => {
            let item = marketData[s];
            let card = document.getElementById(`card-${s}`);
            if (!card) { card = document.createElement('div'); card.id = `card-${s}`; panel.appendChild(card); }

            let sigClass = item.signal === 'BUY' ? 'signal-buy' : (item.signal === 'SELL' ? 'signal-sell' : (item.signal === 'HOLD' ? 'signal-hold' : ''));
            card.className = `card-stat p-4 rounded-lg ${sigClass}`;
            card.innerHTML = `
                <button onclick="removeSymbol('${s}')" class="del-btn absolute top-1 right-2 text-zinc-600 hover:text-white text-xs">Ã—</button>
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-black text-white italic text-base leading-none">${s.replace('USDT','')}</div>
                        <div class="text-[9px] text-zinc-500 mt-1 font-mono">$${item.lastPrice}</div>
                    </div>
                    <div class="text-right text-[8px] font-bold tracking-tighter leading-tight">
                        <div class="text-blue-500">4H: ${item.avgWinRate4h.toFixed(1)}%</div>
                        <div class="text-amber-500">1H: ${item.avgWinRate1h.toFixed(1)}%</div>
                        <div class="text-zinc-400">5M: ${item.avgWinRate5m.toFixed(1)}%</div>
                        <div class="text-lg font-black ${item.winRate > 50 ? 'text-emerald-500' : 'text-red-500'}">${item.winRate.toFixed(1)}%</div>
                    </div>
                </div>
                <div class="h-4 w-full win-gradient rounded-sm relative mb-4">
                    <div class="h4-pointer" style="left: ${item.avgWinRate4h}%"></div>
                    <div class="h1-pointer" style="left: ${item.avgWinRate1h}%"></div>
                    <div class="avg-pointer" style="left: ${item.avgWinRate5m}%"></div>
                    <div class="win-pointer" style="left: ${item.winRate}%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-tighter">
                    <div class="${item.signal==='HOLD'?'text-purple-400':(item.signal==='BUY'?'text-emerald-400':'text-red-400')}">
                        ${item.signal === 'BUY' ? 'â— é‡‘å‰é€²å ´' : (item.signal === 'SELL' ? 'â— æ­»å‰é›¢å ´' : (item.signal === 'HOLD' ? 'ğŸ”¥ å¼·å‹¢éˆåŒ–' : 'ç›£æ§ä¸­'))}
                    </div>
                    <div class="text-zinc-500 font-mono">POW: $${(Math.abs(item.delta)/1000).toFixed(1)}K</div>
                </div>
            `;
        });
    }

    scan();
    setInterval(scan, 10000); 
    setInterval(render, 500);
    document.getElementById('search-input').addEventListener('keypress', (e) => { if(e.key==='Enter') handleSearch(); });
    function handleSearch() {
        const input = document.getElementById('search-input');
        const s = input.value.trim().toUpperCase();
        if (s) { initStream(s.endsWith('USDT')?s:s+'USDT'); input.value=''; }
    }
</script>
</body>
</html>
