<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ TRIDENT V6.3 - FINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background: #050505; color: #d4d4d8; font-family: 'JetBrains Mono', monospace; overflow-x: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        .win-pointer { width: 4px; height: 32px; background: #fff; position: absolute; top: -6px; transition: all 0.1s; box-shadow: 0 0 15px #fff; z-index: 40; }
        .avg-pointer { width: 2px; height: 32px; background: rgba(255,255,255,0.6); position: absolute; top: -6px; border: 1px dashed #fff; z-index: 30; }
        .h1-pointer { width: 2px; height: 32px; background: #f59e0b; position: absolute; top: -6px; border: 1px dotted #f59e0b; z-index: 20; }
        .h4-pointer { width: 2px; height: 32px; background: #3b82f6; position: absolute; top: -6px; z-index: 10; }
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-height: 150px; }
        .sniper-active { border: 2px solid #ef4444 !important; background: #1a0a0a !important; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .chart-box { height: 0; background: #000; margin-top: 0; border-radius: 4px; overflow: hidden; transition: all 0.3s ease; opacity: 0; }
        .chart-box.active { height: 350px; margin-top: 12px; opacity: 1; border: 1px solid #333; }
        .del-btn { opacity: 0; transition: 0.2s; position: absolute; top: 4px; right: 8px; z-index: 50; cursor: pointer; color: #52525b; font-size: 20px; }
        .card-stat:hover .del-btn { opacity: 1; color: #fff; }
        #heartbeat { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .hb-active { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
    </style>
</head>
<body class="flex flex-col h-screen p-4">
    <div class="flex justify-between items-start mb-4">
        <div class="flex items-center">
            <div id="heartbeat"></div>
            <div>
                <h1 class="text-xl font-black text-white italic leading-none text-red-500">TRIDENT V6.3</h1>
                <p class="text-[9px] text-zinc-500 font-mono mt-1 font-bold uppercase tracking-widest">Search & Sniper Priority Mode</p>
            </div>
        </div>
        <div class="flex items-end gap-2">
            <button onclick="testPush()" class="bg-blue-900/40 border border-blue-500 text-blue-400 text-[10px] px-2 py-1 rounded font-bold hover:bg-blue-600 transition">ðŸ“¢ TEST PUSH</button>
            <input type="text" id="search-input" placeholder="SEARCH SYMBOL" class="bg-zinc-900 border border-zinc-700 text-[10px] px-2 py-1 rounded text-white outline-none w-28 uppercase">
            <button onclick="manualSearch()" class="bg-amber-600 hover:bg-amber-500 text-white text-[10px] px-3 py-1 rounded font-bold uppercase">Trace</button>
            <button onclick="location.reload()" class="bg-zinc-800 text-[10px] px-2 py-1 rounded text-zinc-400">RESET</button>
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pb-24"></div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    const P_USER = "Gkhqyhobnxzjfwgvaiyp347m1jkhn4";
    const P_TOKEN = "acyoe3sz15x4n91r1349fdcau7x6pw";
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    let marketData = {}; 
    let sniperTargets = new Set();
    let chartStates = {}; 
    let lastPush = {};
    let lastHeartbeat = Date.now();

    function sendPush(title, msg) {
        fetch("https://api.pushover.net/1/messages.json", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `token=${P_TOKEN}&user=${P_USER}&title=${encodeURIComponent(title)}&message=${encodeURIComponent(msg)}&priority=1`
        });
    }

    function testPush() { sendPush("TRIDENT V6.3 æ¸¬è©¦", "æœå°‹èˆ‡æŽ’åºé‚è¼¯ä¿®å¾©å®Œæˆï¼"); alert("æ¸¬è©¦è¨Šè™Ÿå·²ç™¼é€ï¼"); }

    async function initStream(symbol, isPriority = false) {
        const cleanSymbol = symbol.toUpperCase().endsWith('USDT') ? symbol.toUpperCase() : symbol.toUpperCase() + 'USDT';
        if (marketData[cleanSymbol]?.ws) { 
            if(isPriority) marketData[cleanSymbol].priority = true; 
            render(); // æœå°‹æ™‚ç«‹åˆ»æ¸²æŸ“
            return; 
        }

        try {
            const [ticker, k, f] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${cleanSymbol}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${cleanSymbol}&interval=1m&limit=240`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${cleanSymbol}`).then(r=>r.json())
            ]);

            let d4=0, d1=0, d5m=0;
            k.forEach((v, i) => { 
                let d = parseFloat(v[10]) - (parseFloat(v[7]) - parseFloat(v[10]));
                d4 += d; if(i >= 180) d1 += d; if(i >= 235) d5m += d;
            });

            const ws = new WebSocket(`wss://fstream.binance.com/ws/${cleanSymbol.toLowerCase()}@aggTrade`);
            marketData[cleanSymbol] = { 
                symbol: cleanSymbol, winRate: 50, avgWinRate5m: 50+(d5m/500000*50), avgWinRate1h: 50+(d1/5000000*50), avgWinRate4h: 50+(d4/20000000*50),
                delta: d4, lastPrice: ticker.price, fundingRate: parseFloat(f.lastFundingRate)*100, priority: isPriority, isReady: true, ws: ws,
                maxDelta: 20000, crossFlag: false 
            };
            
            render(); // ç¢ºä¿æ•¸æ“šä¸€ä¾†å°±é¡¯ç¤º

            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                let p = marketData[cleanSymbol]; if(!p) return;
                lastHeartbeat = Date.now(); p.lastPrice = d.p;
                const v = parseFloat(d.q) * parseFloat(d.p);
                p.delta = (p.delta * 0.9995) + (d.m ? -v : v);
                p.maxDelta = Math.max(p.maxDelta * 0.9999, Math.abs(p.delta), 20000);
                let t = 50 + (Math.tanh((p.delta/p.maxDelta) * 1.8) * 50);
                p.winRate = (p.winRate * 0.9) + (t * 0.1);
                if(!p.t5 || Date.now()-p.t5>8000) { p.avgWinRate5m = (p.avgWinRate5m*0.9)+(p.winRate*0.1); p.t5=Date.now(); }
                if(!p.t1 || Date.now()-p.t1>30000) { p.avgWinRate1h = (p.avgWinRate1h*0.98)+(p.winRate*0.02); p.t1=Date.now(); }
                if(!p.t4 || Date.now()-p.t4>120000) { p.avgWinRate4h = (p.avgWinRate4h*0.99)+(p.winRate*0.01); p.t4=Date.now(); }

                if (sniperTargets.has(cleanSymbol)) {
                    const now = Date.now();
                    if (!lastPush[cleanSymbol]) lastPush[cleanSymbol] = 0;
                    if (p.avgWinRate5m > p.avgWinRate1h || p.avgWinRate5m > p.avgWinRate4h) p.crossFlag = true;
                    if (p.crossFlag && (now - lastPush[cleanSymbol] > 300000)) {
                        if (p.avgWinRate5m < p.avgWinRate1h) { sendPush(`ðŸŽ¯ æ¸›ç¢¼: ${cleanSymbol}`, `5M è·Œç ´ 1H`); lastPush[cleanSymbol] = now; p.crossFlag = false; }
                        else if (p.avgWinRate5m < p.avgWinRate4h) { sendPush(`ðŸš¨ æ¸…å€‰: ${cleanSymbol}`, `5M è·Œç ´ 4H`); lastPush[cleanSymbol] = now; p.crossFlag = false; }
                    }
                }
            };
        } catch(e) { console.error("Stream Error", e); }
    }

    function toggleSniper(s) { if (sniperTargets.has(s)) sniperTargets.delete(s); else sniperTargets.add(s); render(); }

    function toggleChart(s) {
        const box = document.getElementById(`box-${s}`);
        const containerId = `chart-container-${s}`;
        if (chartStates[s]) { box.classList.remove('active'); setTimeout(() => { box.innerHTML = ''; }, 300); chartStates[s] = false; } 
        else {
            box.classList.add('active'); box.innerHTML = `<div id="${containerId}" style="height:100%; width:100%;"></div>`;
            new TradingView.widget({ "autosize": true, "symbol": "BINANCE:" + s + "PERP", "interval": "1", "theme": "dark", "style": "1", "hide_top_toolbar": true, "container_id": containerId });
            chartStates[s] = true;
        }
    }

    function removeSymbol(s) { if(marketData[s]) { if(marketData[s].ws) marketData[s].ws.close(); delete marketData[s]; sniperTargets.delete(s); delete chartStates[s]; render(); } }

    function manualSearch() {
        const input = document.getElementById('search-input');
        const s = input.value.trim().toUpperCase();
        if (s) { initStream(s, true); input.value = ''; }
    }

    function render() {
        const panel = document.getElementById('main-panel');
        // æ ¸å¿ƒä¿®æ­£ï¼šæŽ’åºé‚è¼¯ã€‚å„ªå…ˆé †åºï¼šæœå°‹éŽçš„(Priority) > ç‹™æ“Šä¸­(Target) > å…¶ä»–æŽ’å
        const sorted = Object.keys(marketData).filter(s => marketData[s].isReady)
            .sort((a,b) => {
                let scoreA = (marketData[a].priority ? 2000 : 0) + (sniperTargets.has(a) ? 1000 : 0);
                let scoreB = (marketData[b].priority ? 2000 : 0) + (sniperTargets.has(b) ? 1000 : 0);
                return (scoreB - scoreA) || (marketData[b].winRate - marketData[a].winRate);
            }).slice(0, 20);

        const hb = document.getElementById('heartbeat');
        hb.className = (Date.now() - lastHeartbeat < 1000) ? 'hb-active' : '';

        sorted.forEach(s => {
            let item = marketData[s]; let card = document.getElementById(`card-${s}`);
            if (!card) { card = document.createElement('div'); card.id = `card-${s}`; panel.appendChild(card); }
            const isSniper = sniperTargets.has(s);
            card.className = `card-stat p-4 rounded-lg flex flex-col ${isSniper ? 'sniper-active' : ''}`;
            if (card.querySelector('.stat-header') === null) {
                card.innerHTML = `<div onclick="removeSymbol('${s}')" class="del-btn font-bold">Ã—</div><div class="stat-header"></div>
                    <div class="h-3 w-full win-gradient rounded-sm relative my-2 border border-zinc-900 overflow-hidden">
                        <div class="h4-pointer" id="h4-${s}"></div><div class="h1-pointer" id="h1-${s}"></div><div class="avg-pointer" id="avg-${s}"></div><div class="win-pointer" id="win-${s}"></div>
                    </div>
                    <div class="flex justify-between items-center gap-2 mt-1">
                        <button onclick="toggleSniper('${s}')" class="sniper-btn text-[10px] font-bold flex-1 py-1.5 rounded transition-all"></button>
                        <button onclick="toggleChart('${s}')" class="bg-zinc-800 text-zinc-400 text-[10px] font-bold flex-1 py-1.5 rounded hover:bg-zinc-700 hover:text-white">VIEW 1K</button>
                    </div><div id="box-${s}" class="chart-box"></div>`;
            }
            card.querySelector('.stat-header').innerHTML = `<div class="flex justify-between items-start">
                <div><div class="font-black text-white italic text-base leading-none">${s.replace('USDT','')}</div><div class="text-[10px] text-zinc-500 mt-1.5">$${parseFloat(item.lastPrice).toFixed(4)}</div></div>
                <div class="text-right"><div class="text-xl font-black ${item.winRate>50?'text-emerald-500':'text-red-500'}">${item.winRate.toFixed(1)}%</div><div class="text-[8px] text-zinc-600 font-bold mt-1">4H:${item.avgWinRate4h.toFixed(1)} 1H:${item.avgWinRate1h.toFixed(1)}</div></div></div>`;
            card.querySelector(`#h4-${s}`).style.left = `${item.avgWinRate4h}%`;
            card.querySelector(`#h1-${s}`).style.left = `${item.avgWinRate1h}%`;
            card.querySelector(`#avg-${s}`).style.left = `${item.avgWinRate5m}%`;
            card.querySelector(`#win-${s}`).style.left = `${item.winRate}%`;
            const sBtn = card.querySelector('.sniper-btn');
            sBtn.innerText = isSniper ? 'ðŸŽ¯ MONITORING' : 'ðŸŽ¯ TARGET';
            sBtn.className = `sniper-btn text-[10px] font-bold flex-1 py-1.5 rounded transition-all ${isSniper ? 'bg-red-600 text-white animate-pulse' : 'bg-zinc-900 text-zinc-600'}`;
        });
        Array.from(panel.children).forEach(c => { if(!sorted.includes(c.id.replace('card-',''))) c.remove(); });
    }

    async function globalScan() {
        const tickers = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        const top = tickers.filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol)).sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume)).slice(0, 16);
        for(let s of top) { await initStream(s.symbol); }
    }

    globalScan();
    setInterval(render, 1000); 
    setInterval(globalScan, 60000);
    document.getElementById('search-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') manualSearch(); });
</script>
</body>
</html>
