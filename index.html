<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>⚡ TRIDENT COMMANDER V1.5 - SEARCH & TRACK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #d4d4d8; font-family: 'Inter', system-ui; overflow: hidden; }
        .win-gradient { background: linear-gradient(90deg, #ef4444 0%, #18181b 50%, #22c55e 100%); }
        .win-pointer { width: 4px; height: 30px; background: white; position: absolute; top: -5px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-stat { background: #0f0f11; border: 1px solid #1f1f23; }
        .fire-bg { background: linear-gradient(180deg, rgba(168, 85, 247, 0.1) 0%, transparent 100%); border: 1px solid #a855f7; }
        input:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 10px rgba(168, 85, 247, 0.3); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-black text-white tracking-tighter italic">TRIDENT COMMANDER <span class="text-xs font-normal text-zinc-500 not-italic">v1.5</span></h1>
            <p class="text-[10px] text-zinc-500 uppercase tracking-widest">Global Aggressor Search System</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <input type="text" id="search-input" placeholder="搜尋幣種 (例如: PEPE, DOGE)..." 
                class="bg-zinc-900 border border-zinc-800 rounded-lg px-4 py-2 text-sm w-full md:w-64 text-white">
            <button onclick="handleSearch()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all">追蹤</button>
        </div>

        <div id="connection-status" class="hidden md:flex items-center text-[10px] text-emerald-500">
            <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></span>
            L3 DATA LIVE
        </div>
    </div>

    <div id="main-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2">
        </div>

<script>
    const EXCLUDE = ['BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT','BNBUSDT','BNXUSDT'];
    const CONFIG = {
        lookback: 1000,
        fireThreshold: 75,
        refreshRate: 800
    };

    let marketData = {}; 

    // 初始化 WebSocket (歸一化邏輯)
    function initStream(symbol) {
        if (marketData[symbol]) return; // 不重複啟動

        const formattedSymbol = symbol.toUpperCase().endsWith('USDT') ? symbol.toUpperCase() : symbol.toUpperCase() + 'USDT';
        
        try {
            const ws = new WebSocket(`wss://fstream.binance.com/ws/${formattedSymbol.toLowerCase()}@aggTrade`);
            
            marketData[formattedSymbol] = {
                symbol: formattedSymbol,
                trades: [],
                winRate: 50,
                delta: 0,
                lastPrice: 0,
                maxDelta: 1,
                avgSize: 0,
                historyDelta: [],
                isManual: false // 標記是否為手動搜尋
            };

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                const price = parseFloat(data.p);
                const size = parseFloat(data.q);
                const isSell = data.m;

                let pool = marketData[formattedSymbol];
                pool.lastPrice = price;

                // 統計大單基準
                if (pool.trades.length < CONFIG.lookback) {
                    pool.trades.push(size);
                    pool.avgSize = pool.trades.reduce((a, b) => a + b, 0) / pool.trades.length;
                } else {
                    pool.trades.shift();
                    pool.trades.push(size);
                    pool.avgSize = pool.trades.reduce((a, b) => a + b, 0) / pool.trades.length;
                }

                // 加權運算
                const weight = size > pool.avgSize * 3 ? 5 : 1; 
                const currentDelta = isSell ? -(size * weight) : (size * weight);
                pool.delta += currentDelta;

                pool.historyDelta.push(currentDelta);
                if (pool.historyDelta.length > 500) {
                    pool.delta -= pool.historyDelta.shift();
                }

                // 歸一化勝率
                pool.maxDelta = Math.max(pool.maxDelta, Math.abs(pool.delta));
                pool.winRate = 50 + ((pool.delta / pool.maxDelta) * 50);
            };

            ws.onerror = () => { delete marketData[formattedSymbol]; };
        } catch(e) { console.log("WS Error"); }
    }

    // 搜尋功能處理
    function handleSearch() {
        const input = document.getElementById('search-input');
        const symbol = input.value.trim().toUpperCase();
        if (symbol) {
            initStream(symbol);
            marketData[symbol.endsWith('USDT') ? symbol : symbol + 'USDT'].isManual = true;
            input.value = '';
            // 搜尋後滾動到頂部查看
            document.getElementById('main-panel').scrollTop = 0;
        }
    }

    // 監聽 Enter 鍵
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
    });

    function render() {
        const panel = document.getElementById('main-panel');
        // 先顯示手動追蹤的，再顯示自動抓取的
        const sortedSymbols = Object.keys(marketData).sort((a, b) => {
            return (marketData[b].isManual - marketData[a].isManual);
        });

        sortedSymbols.forEach(s => {
            let item = marketData[s];
            let card = document.getElementById(`card-${s}`);

            if (!card) {
                card = document.createElement('div');
                card.id = `card-${s}`;
                panel.prepend(card); // 新搜尋的置頂
            }

            const isHighWin = item.winRate > CONFIG.fireThreshold;
            const isLowWin = item.winRate < (100 - CONFIG.fireThreshold);

            card.className = `card-stat p-4 rounded-xl relative overflow-hidden mb-2 transition-all duration-500 ${isHighWin ? 'fire-bg border-purple-500/50' : ''} ${item.isManual ? 'ring-1 ring-zinc-700' : ''}`;

            card.innerHTML = `
                ${item.isManual ? '<span class="absolute top-0 right-0 bg-zinc-800 text-[8px] px-2 py-0.5 text-zinc-400 rounded-bl-lg">TRACKING</span>' : ''}
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-xl font-black text-white flex items-center">
                            ${s.replace('USDT','')}
                        </div>
                        <div class="text-[10px] text-zinc-500">$${item.lastPrice.toLocaleString()}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black ${item.winRate > 50 ? 'text-emerald-500' : 'text-red-500'}">
                            ${item.winRate.toFixed(1)}%
                        </div>
                        <div class="text-[8px] uppercase tracking-tighter text-zinc-500">Aggressor Advantage</div>
                    </div>
                </div>

                <div class="h-2.5 w-full win-gradient rounded-full relative mb-4 opacity-80">
                    <div class="win-pointer shadow-[0_0_10px_white]" style="left: ${item.winRate}%"></div>
                </div>

                <div class="flex justify-between items-center text-[10px]">
                    <div class="font-mono ${item.delta > 0 ? 'text-emerald-400' : 'text-red-400'}">
                        Δ ${item.delta > 0 ? '+' : ''}${Math.abs(item.delta).toFixed(0)}
                    </div>
                    <div class="font-bold px-2 py-0.5 rounded ${isHighWin ? 'bg-emerald-500/20 text-emerald-400' : (isLowWin ? 'bg-red-500/20 text-red-400' : 'text-zinc-600')}">
                        ${isHighWin ? 'STRONG BUY' : (isLowWin ? 'STRONG SELL' : 'NEUTRAL')}
                    </div>
                </div>
            `;
        });
    }

    async function init() {
        const data = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        // 預設抓成交量前 24 名
        const targets = data
            .filter(s => s.symbol.endsWith('USDT') && !EXCLUDE.includes(s.symbol))
            .sort((a,b)=>b.quoteVolume-a.quoteVolume)
            .slice(0, 24);

        targets.forEach(t => initStream(t.symbol));
        setInterval(render, CONFIG.refreshRate);
    }

    init();
</script>
</body>
</html>
