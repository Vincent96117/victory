<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIDENT V7-C | Pre-Break (1~3m) Long-only + Gemini</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#050505; color:#d4d4d8; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .card { background:#0f0f11; border:1px solid #1f1f23; }
    .pill { border:1px solid #27272a; background:#0b0b0d; }
    .k { color:#a1a1aa; font-size:11px; }
    .v { color:#e5e7eb; font-weight:700; font-size:12px; }
    .stage-setup { background: rgba(234,179,8,.14); border-color: rgba(234,179,8,.5); color:#fbbf24; }
    .stage-ignite { background: rgba(249,115,22,.14); border-color: rgba(249,115,22,.5); color:#fb923c; }
    .stage-confirm { background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.5); color:#4ade80; }
    .stage-none { background: rgba(148,163,184,.10); border-color: rgba(148,163,184,.25); color:#94a3b8; }
    .lock { border:2px solid #22c55e !important; box-shadow:0 0 20px rgba(34,197,94,.10); }
    .badge { font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2f; }
    .btn { background:#111827; border:1px solid #374151; color:#e5e7eb; }
    .btn:hover { background:#1f2937; }
    .btn2 { background:#0b1220; border:1px solid #1d4ed8; color:#93c5fd; }
    .btn2:hover { background:#172554; }
    .btnDanger { background:#1a0a0a; border:1px solid #ef4444; color:#fecaca; }
    .btnDanger:hover { background:#2a0b0b; }
    .dot { width:9px; height:9px; border-radius:999px; display:inline-block; }
    .dotGray { background:#52525b; box-shadow:none; }
    .dotAmber { background:#f59e0b; box-shadow:0 0 10px rgba(245,158,11,.55); }
    .dotGreen { background:#22c55e; box-shadow:0 0 10px rgba(34,197,94,.55); }
    .dotRed { background:#ef4444; box-shadow:0 0 10px rgba(239,68,68,.55); }
    .mono { font-variant-numeric: tabular-nums; }
    .small { font-size:11px; color:#a1a1aa; }
    .aiBox { background:#070709; border:1px solid #222227; }
    .aiTitle { font-weight:900; color:#fff; }
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
  </style>
</head>

<body class="p-4">
  <!-- Header -->
  <div class="flex flex-col gap-3 mb-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <span id="gemDot" class="dot dotGray"></span>
        <div>
          <div class="text-xl font-black italic text-white">
            TRIDENT <span class="text-emerald-400">V7-C</span>
            <span class="text-zinc-500 text-sm font-bold">Pre-Break 1~3m Â· LONG ONLY</span>
          </div>
          <div class="small">
            ç›®æ¨™ï¼šåªæŠ“ã€Œçªç ´å‰ 1~3 åˆ†é˜ã€ï¼šè²¼å£“åŠ›(20é«˜) + 1mé‡çˆ¬å‡ + 1m/5mä¸»å‹•è²·å…¥å·®é¡ç‚ºæ­£ + anti-chase
          </div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <input id="keyInput" type="password" placeholder="è²¼ä¸Š Gemini API Keyï¼ˆåªå­˜æœ¬æ©Ÿ localStorageï¼‰"
          class="w-[360px] max-w-full bg-zinc-900 border border-zinc-700 text-[12px] px-3 py-2 rounded text-white outline-none" />
        <button id="btnSaveKey" class="btn px-3 py-2 rounded text-[12px] font-bold">Save</button>
        <button id="btnClearKey" class="btnDanger px-3 py-2 rounded text-[12px] font-bold">Clear</button>

        <button id="btnTestGemini" class="btn2 px-3 py-2 rounded text-[12px] font-bold">Test Gemini</button>
        <button id="btnAnalyzeTop" class="btn2 px-3 py-2 rounded text-[12px] font-bold">Analyze Top3</button>

        <label class="flex items-center gap-2 text-[12px] select-none">
          <input id="autoToggle" type="checkbox" class="accent-emerald-500" />
          Autoï¼ˆåªåœ¨ğŸŸ§é»ç«æ‰æ‰“ï¼‰
        </label>

        <button id="btnReset" class="btn px-3 py-2 rounded text-[12px] font-bold">RESET</button>
      </div>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-2">
      <div class="small mono" id="statusLine">status: -</div>
      <div class="small mono">
        æ›´æ–°ï¼š<span id="lastUpdate">-</span>ã€€|ã€€
        æ¨¡å‹ï¼š<span id="modelName">gemini-2.5-flash</span>ã€€|ã€€
        max_outï¼š<span id="maxOut">420</span>ã€€|ã€€
        TopKï¼š<span id="topK">3</span>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="card rounded-xl p-4 mb-4">
    <div class="flex items-center justify-between">
      <div class="text-white font-black">Top 5ï¼ˆæœ€å¼·é–å®šç½®é ‚ï¼Œé™¤éæœ‰äººæ˜é¡¯æ›´å¼·æ‰æ›ï¼‰</div>
      <div class="small mono">Universeï¼š<span id="univN">-</span>ã€€|ã€€Readyï¼š<span id="readyN">-</span></div>
    </div>
  </div>

  <div id="panel" class="flex flex-col gap-3"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const BINANCE = "https://fapi.binance.com";
    const MODEL = "gemini-2.5-flash";
    const MAX_OUTPUT_TOKENS = 420;
    const TOPK_ANALYZE = 3;

    // æƒæç¯€å¥ï¼ˆåˆ¥å¤ªå¿«ï¼Œé¿å… Binance rate limitï¼‰
    const AUTO_INTERVAL_MS = 120000;     // 2 åˆ†é˜
    const SCAN_INTERVAL_MS = 6000;       // 6 ç§’æ›´æ–°ä¸€æ‰¹
    const UNIVERSE_SIZE = 80;            // åªå–æˆäº¤é¡å¤§çš„å‰ 80
    const EXCLUDE = new Set(["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]);

    // Long-onlyï¼šè¿½é«˜é™åˆ¶
    const CHASE_RET5M_MAX = 1.20;        // 5m æ¼²å¤ªå¤šè¦–ç‚ºè¿½é«˜
    const REQUIRE_BULL_TREND = true;     // EMA20>EMA50 ä¸” åƒ¹åœ¨EMA20ä¸Š æ‰åŠ åˆ†/Confirmæ›´åš´

    // === C æ¨¡å¼ï¼šçªç ´å‰ 1~3 åˆ†é˜ï¼ˆPre-Breakï¼‰ ===
    const PREBREAK_TO_HIGH_MAX_PCT = 0.18;   // è·é›¢20é«˜é» <= 0.18%
    const PREBREAK_RET5M_MIN = -0.05;        // 5m ä¸è¦å¤ªå¼±
    const PREBREAK_RET5M_MAX = 0.60;         // 5m ä¸è¦å·²ç¶“å™´
    const PREBREAK_VOL1M_RATIO_MIN = 1.6;    // 1mé‡ / 20mä¸­ä½æ•¸ >= 1.6
    const PREBREAK_VOL1M_Z_MIN = 1.2;        // 1mé‡Z >= 1.2
    const PREBREAK_ACTIVE1M_POS = 0;         // 1mä¸»å‹•è²·å…¥å·®é¡ > 0

    // Gemini ç¯€æµ
    const PER_SYMBOL_COOLDOWN_MS = 60000;      // åŒå¹£ 60s å†·å»
    const GLOBAL_MIN_GAP_MS = 1400;            // Gemini é€£æ‰“é–“éš”
    const COOLDOWN_ON_429_MS = 5 * 60 * 1000;  // 429 å…¨ç«™å†·å» 5m

    /***********************
     * STATE
     ***********************/
    const S = {
      key: "",
      keyOk: false,
      keyLastOkAt: 0,
      globalCooldownUntil: 0,
      lastGeminiAt: 0,

      universe: [],
      rrIdx: 0,
      symbols: new Map(),     // symbol -> data
      locked: null,           // é–å®šæœ€å¼·
    };

    /***********************
     * DOM
     ***********************/
    const $ = (id) => document.getElementById(id);
    const panel = $("panel");
    $("modelName").innerText = MODEL;
    $("maxOut").innerText = String(MAX_OUTPUT_TOKENS);
    $("topK").innerText = String(TOPK_ANALYZE);

    function setStatus(t) { $("statusLine").innerText = "status: " + t; }
    function setDot(mode) {
      const d = $("gemDot");
      d.className = "dot " + (mode==="green" ? "dotGreen" : mode==="amber" ? "dotAmber" : mode==="red" ? "dotRed" : "dotGray");
    }
    function fmtPct(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      return (x >= 0 ? "+" : "") + x.toFixed(dp) + "%";
    }
    function fmtNum(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      return Number(x).toFixed(dp);
    }
    function nowHHMMSS() {
      const d = new Date();
      return d.toLocaleTimeString("zh-TW",{hour12:false});
    }

    /***********************
     * STORAGE: KEY
     ***********************/
    function loadKey() {
      const k = localStorage.getItem("TRIDENT_GEMINI_KEY") || "";
      S.key = k;
      $("keyInput").value = k ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "";
      updateKeyUi();
    }
    function saveKeyFromInput() {
      const raw = $("keyInput").value.trim();
      if (!raw || raw.includes("â€¢â€¢â€¢â€¢")) {
        setStatus("è«‹é‡æ–°è²¼ä¸Šå®Œæ•´ Keyï¼ˆä¸è¦æ˜¯ â€¢â€¢â€¢â€¢ï¼‰");
        return;
      }
      S.key = raw;
      localStorage.setItem("TRIDENT_GEMINI_KEY", raw);
      $("keyInput").value = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
      setStatus("Key saved");
      updateKeyUi();
    }
    function clearKey() {
      S.key = "";
      S.keyOk = false;
      S.keyLastOkAt = 0;
      localStorage.removeItem("TRIDENT_GEMINI_KEY");
      $("keyInput").value = "";
      setStatus("Key cleared");
      updateKeyUi();
    }
    function updateKeyUi() {
      if (!S.key) { setDot("gray"); return; }
      if (Date.now() < S.globalCooldownUntil) { setDot("red"); return; }
      if (S.keyOk && (Date.now() - S.keyLastOkAt < 5*60*1000)) setDot("green");
      else setDot("amber");
    }

    /***********************
     * UTILS
     ***********************/
    async function fetchJSON(url, timeoutMs=9000) {
      const ac = new AbortController();
      const t = setTimeout(() => ac.abort(), timeoutMs);
      try {
        const r = await fetch(url, { signal: ac.signal });
        const txt = await r.text();
        let j = null;
        try { j = JSON.parse(txt); } catch(e) { j = { _raw: txt }; }
        return { ok: r.ok, status: r.status, data: j };
      } catch (e) {
        return { ok: false, status: 0, data: { error: String(e) } };
      } finally {
        clearTimeout(t);
      }
    }

    function ema(values, period) {
      if (values.length < period) return null;
      const k = 2 / (period + 1);
      let e = values[0];
      for (let i=1;i<values.length;i++) e = values[i]*k + e*(1-k);
      return e;
    }

    function meanStd(arr) {
      if (!arr.length) return { m:0, s:0 };
      const m = arr.reduce((a,b)=>a+b,0)/arr.length;
      const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
      return { m, s: Math.sqrt(v) };
    }

    function zscore(x, m, s) {
      if (!s || s === 0) return 0;
      return (x - m)/s;
    }

    function median(arr) {
      if (!arr.length) return 0;
      const a = [...arr].sort((x,y)=>x-y);
      const m = Math.floor(a.length/2);
      return a.length % 2 ? a[m] : (a[m-1] + a[m]) / 2;
    }

    /***********************
     * UNIVERSE
     ***********************/
    async function refreshUniverse() {
      const r = await fetchJSON(`${BINANCE}/fapi/v1/ticker/24hr`, 12000);
      if (!r.ok || !Array.isArray(r.data)) {
        setStatus("Binance 24hr tickers è®€å–å¤±æ•—");
        return;
      }
      const all = r.data
        .filter(x => x.symbol && x.symbol.endsWith("USDT") && !EXCLUDE.has(x.symbol))
        .map(x => ({ symbol: x.symbol, qv: Number(x.quoteVolume || 0) }))
        .filter(x => x.qv > 5_000_000)
        .sort((a,b) => b.qv - a.qv)
        .slice(0, UNIVERSE_SIZE)
        .map(x => x.symbol);

      S.universe = all;
      $("univN").innerText = String(all.length);
      setStatus("Universe refreshed: " + all.length);
    }

    /***********************
     * CORE: UPDATE SYMBOL
     ***********************/
    async function updateSymbol(symbol) {
      const st = S.symbols.get(symbol) || {
        symbol,
        score: 0,
        scoreSmooth: 0,
        stage: "NONE",
        stageReason: "",
        last: {},
        hist: {
          oi: [],
          tsOi: [],
          oi5m: [],
        },
        ai: {
          lastAt: 0,
          lastOk: false,
          lastErr: "",
          cooldownUntil: 0,
          obj: null
        }
      };

      const [k, p, oi] = await Promise.all([
        fetchJSON(`${BINANCE}/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=240`, 12000),
        fetchJSON(`${BINANCE}/fapi/v1/premiumIndex?symbol=${symbol}`, 9000),
        fetchJSON(`${BINANCE}/fapi/v1/openInterest?symbol=${symbol}`, 9000),
      ]);

      if (!k.ok || !Array.isArray(k.data)) {
        st.last.err = "klines fail";
        S.symbols.set(symbol, st);
        return;
      }

      const kl = k.data;
      const closes = kl.map(x => Number(x[4]));
      const highs  = kl.map(x => Number(x[2]));
      const lows   = kl.map(x => Number(x[3]));
      const quoteV = kl.map(x => Number(x[7]));   // quote asset volume
      const takerQ = kl.map(x => Number(x[10]));  // taker buy quote volume

      const lastC = closes[closes.length-1];
      const c_5m  = closes[closes.length-6] ?? closes[0];
      const ret5m = (lastC - c_5m) / c_5m * 100;

      // === 5m æˆäº¤é¡ç•°å¸¸ï¼ˆè·Ÿè‡ªå·± 4h çš„ 5m åˆ†ä½ˆæ¯”ï¼‰ ===
      const win5mQuote = [];
      for (let i=0;i<240;i+=5) win5mQuote.push(quoteV.slice(i,i+5).reduce((a,b)=>a+b,0));
      const last5mVol = quoteV.slice(-5).reduce((a,b)=>a+b,0);
      const msVol5 = meanStd(win5mQuote.slice(0,-1));
      const volZ5 = zscore(last5mVol, msVol5.m, msVol5.s);

      // === ä¸»å‹•è²·å…¥å·®é¡ï¼ˆ5m / 4hï¼‰ ===
      const sumQ5 = quoteV.slice(-5).reduce((a,b)=>a+b,0);
      const sumT5 = takerQ.slice(-5).reduce((a,b)=>a+b,0);
      const activeDiff5m = (2*sumT5 - sumQ5);
      const activeRatio5m = sumQ5 > 0 ? (sumT5 / sumQ5) : null;

      const sumQ4 = quoteV.reduce((a,b)=>a+b,0);
      const sumT4 = takerQ.reduce((a,b)=>a+b,0);
      const activeDiff4h = (2*sumT4 - sumQ4);
      const activeRatio4h = sumQ4 > 0 ? (sumT4 / sumQ4) : null;

      // === è¶¨å‹¢ EMAï¼ˆLong-onlyï¼‰ ===
      const ema20 = ema(closes.slice(-60), 20);
      const ema50 = ema(closes.slice(-120), 50);
      const trendOk = (ema20 && ema50) ? (ema20 > ema50 && lastC >= ema20) : false;

      // === Premium / Funding ===
      let premiumPct = null, fundingPct = null;
      if (p.ok && p.data) {
        const mp = Number(p.data.markPrice || 0);
        const ip = Number(p.data.indexPrice || 0);
        premiumPct = (ip > 0) ? ((mp - ip) / ip * 100) : null;
        fundingPct = Number(p.data.lastFundingRate || 0) * 100;
      }

      // === OIï¼ˆå‰ç«¯å¿«ç…§ç´¯ç©ï¼‰ ===
      const oiNow = (oi.ok && oi.data) ? Number(oi.data.openInterest || 0) : null;
      let oi5mChg = null;
      let oi4hChg = null;
      let oiZ5 = 0;

      const tNow = Date.now();
      if (oiNow !== null) {
        st.hist.oi.push(oiNow);
        st.hist.tsOi.push(tNow);

        const t5 = tNow - 5*60*1000;
        for (let i=st.hist.tsOi.length-1;i>=0;i--) {
          if (st.hist.tsOi[i] <= t5) { oi5mChg = oiNow - st.hist.oi[i]; break; }
        }
        const t4 = tNow - 4*60*60*1000;
        for (let i=st.hist.tsOi.length-1;i>=0;i--) {
          if (st.hist.tsOi[i] <= t4) { oi4hChg = oiNow - st.hist.oi[i]; break; }
        }

        const tKeep = tNow - 6*60*60*1000;
        while (st.hist.tsOi.length && st.hist.tsOi[0] < tKeep) {
          st.hist.tsOi.shift(); st.hist.oi.shift();
        }

        if (oi5mChg !== null) {
          st.hist.oi5m.push(oi5mChg);
          if (st.hist.oi5m.length > 120) st.hist.oi5m.shift();
          const msOi = meanStd(st.hist.oi5m.slice(0,-1));
          oiZ5 = zscore(oi5mChg, msOi.m, msOi.s);
        }
      }

      // === Pre-Break æ ¸å¿ƒï¼š1mé‡çˆ¬å‡ + 1mä¸»å‹•è²·å…¥å·®é¡ + è²¼è¿‘20é«˜ ===
      const last1mVol = quoteV[quoteV.length - 1] ?? 0;
      const vol20 = quoteV.slice(-21, -1);
      const vol20Med = median(vol20);
      const vol1mRatio = vol20Med > 0 ? (last1mVol / vol20Med) : 0;

      const msVol1m = meanStd(vol20);
      const vol1mZ = zscore(last1mVol, msVol1m.m, msVol1m.s);

      const q1 = quoteV[quoteV.length - 1] ?? 0;
      const t1 = takerQ[takerQ.length - 1] ?? 0;
      const activeDiff1m = (2 * t1 - q1);

      const range20High = Math.max(...highs.slice(-20));
      const range20Low  = Math.min(...lows.slice(-20));
      const toHighPct = (range20High > 0) ? ((range20High - lastC) / lastC * 100) : 999;
      const nearHigh = (toHighPct >= 0 && toHighPct <= PREBREAK_TO_HIGH_MAX_PCT);
      const brokeHigh = (lastC > range20High * 1.0003); // 0.03%

      // === Stageï¼ˆC æ¨¡å¼ï¼‰ ===
      const retOk = (ret5m >= PREBREAK_RET5M_MIN && ret5m <= PREBREAK_RET5M_MAX);
      const rampOk = (vol1mRatio >= PREBREAK_VOL1M_RATIO_MIN) || (vol1mZ >= PREBREAK_VOL1M_Z_MIN);
      const activeOk = (activeDiff1m > PREBREAK_ACTIVE1M_POS) && (activeDiff5m > 0);

      let stage = "NONE", stageReason = "";

      // Setupï¼šé‡/æ³¢å‹•ç•°å¸¸ + è²·ç›¤ä¸å¼±
      if (volZ5 >= 1.6 && (activeDiff5m > 0 || (activeRatio5m !== null && activeRatio5m >= 0.50))) {
        stage = "SETUP";
        stageReason = "é‡/æ³¢å‹•é–‹å§‹ç•°å¸¸ + è²·ç›¤åå¤š";
      }

      // Igniteï¼ˆPre-Breakï¼‰ï¼šè²¼è¿‘å£“åŠ› + é‡çˆ¬å‡ + ä¸»å‹•è²·å…¥æ¨é€² + retOkï¼ˆä¸è¿½é«˜ï¼‰
      if (stage !== "NONE" && nearHigh && rampOk && activeOk && retOk) {
        stage = "IGNITE";
        stageReason = "çªç ´å‰(1~3m)ï¼šè²¼è¿‘å£“åŠ› + é‡çˆ¬å‡ + ä¸»å‹•è²·å…¥æ¨";
      }

      // Confirmï¼šå·²çªç ´ + ä¸è¿½é«˜ + è¶¨å‹¢OK
      const notChase = ret5m <= CHASE_RET5M_MAX;
      if (stage === "IGNITE" && brokeHigh && notChase && (!REQUIRE_BULL_TREND || trendOk)) {
        stage = "CONFIRM";
        stageReason = "å·²çªç ´å£“åŠ›ä½ï¼šå¯åŸ·è¡Œ";
      }

      // === Scoreï¼ˆæ›´å Pre-Breakï¼‰ ===
      const chasePenalty = Math.max(0, ret5m - CHASE_RET5M_MAX) * 10;

      let score =
        (volZ5 * 6) +
        (Math.max(0, oiZ5) * 3) +
        ((activeDiff5m > 0) ? 5 : -7) +
        ((activeRatio5m !== null) ? (activeRatio5m - 0.5) * 18 : 0) +
        (trendOk ? 5 : (REQUIRE_BULL_TREND ? -5 : 0)) +
        (ret5m > 0 ? 2 : -5) -
        chasePenalty;

      // Pre-break åŠ æ¬Šï¼šè¶Šè²¼è¿‘å£“åŠ›è¶Šé«˜
      let preBreakBoost = 0;
      if (nearHigh) preBreakBoost += ((PREBREAK_TO_HIGH_MAX_PCT - toHighPct) / PREBREAK_TO_HIGH_MAX_PCT) * 18;
      preBreakBoost += Math.max(0, (vol1mRatio - 1.0)) * 6;
      preBreakBoost += Math.max(0, vol1mZ) * 3;
      preBreakBoost += (activeDiff1m > 0 ? 8 : -8);
      score += preBreakBoost;

      if (stage === "SETUP") score += 4;
      if (stage === "IGNITE") score += 12;
      if (stage === "CONFIRM") score += 18;

      st.score = score;
      st.scoreSmooth = st.scoreSmooth ? (st.scoreSmooth*0.78 + score*0.22) : score;
      st.stage = stage;
      st.stageReason = stageReason;

      st.last = {
        price: lastC,
        ret5m,
        volZ: volZ5,
        fund: fundingPct,
        premium: premiumPct,
        activeDiff1m,
        activeDiff5m,
        activeDiff4h,
        activeRatio5m,
        activeRatio4h,
        oiNow,
        oi5mChg,
        oi4hChg,
        oiZ5,
        ema20, ema50, trendOk,
        range20High, range20Low,
        toHighPct,
        vol1mRatio,
        vol1mZ,
      };

      S.symbols.set(symbol, st);
    }

    /***********************
     * TOP5 + LOCK
     ***********************/
    function stageBadge(stage) {
      if (stage === "SETUP") return { cls:"stage-setup", text:"ğŸŸ¨ è“„å‹¢ï¼ˆSetupï¼‰" };
      if (stage === "IGNITE") return { cls:"stage-ignite", text:"ğŸŸ§ é»ç«ï¼ˆPre-Breakï¼‰" };
      if (stage === "CONFIRM") return { cls:"stage-confirm", text:"ğŸŸ© è§¸ç™¼ï¼ˆConfirmï¼‰" };
      return { cls:"stage-none", text:"â¬› ç„¡" };
    }

    function passLongOnlyFilter(st) {
      // é¿å…ã€Œè·Œæˆå–œæ†¨ã€åˆæ··é€²ä¾†ï¼š5m æ˜é¡¯è²  + ä¸»å‹•è²·å…¥å·®é¡ <=0
      const r = st.last.ret5m;
      const ad5 = st.last.activeDiff5m;
      if (r < -0.15 && ad5 !== null && ad5 <= 0) return false;

      // è¿½é«˜æ§åˆ¶ï¼ˆå¤ªå™´çš„ç›´æ¥é™ä½å…¥æ¦œæ©Ÿç‡ï¼‰
      if (r > 1.9) return false;

      // C æ¨¡å¼è¦æ›´åƒã€Œçªç ´å‰ã€ï¼šè·é«˜å¤ªé çš„ä¸è¦
      if (st.last.toHighPct === null || st.last.toHighPct === undefined) return false;
      if (st.last.toHighPct > 0.60) return false;

      return true;
    }

    function pickTop5() {
      const arr = Array.from(S.symbols.values())
        .filter(x => x.last && x.last.price)
        .filter(passLongOnlyFilter)
        .sort((a,b) => (b.scoreSmooth - a.scoreSmooth));

      // å„ªå…ˆåªæ”¶æœ‰ç‡ˆè™Ÿçš„ï¼ˆSetup/Ignite/Confirmï¼‰
      const lit = arr.filter(x => x.stage !== "NONE");
      const pool = (lit.length >= 5) ? lit : arr;

      let top = pool.slice(0, 5);

      // é–å®šæœ€å¼·ï¼šé™¤éæœ‰äººæ˜é¡¯æ›´å¼·ï¼ˆ>= 8åˆ†ï¼‰æ‰æ›
      if (!S.locked && top.length) S.locked = top[0].symbol;
      if (S.locked) {
        const lockedObj = top.find(x => x.symbol === S.locked) || S.symbols.get(S.locked);
        const best = top[0];
        if (lockedObj && best && best.symbol !== S.locked) {
          const lockedScore = lockedObj.scoreSmooth || 0;
          const bestScore = best.scoreSmooth || 0;
          if (bestScore - lockedScore >= 8) S.locked = best.symbol;
        }
        top = top.sort((a,b) => (a.symbol === S.locked ? -1 : b.symbol === S.locked ? 1 : (b.scoreSmooth - a.scoreSmooth)));
      }

      $("readyN").innerText = String(S.symbols.size);
      return top;
    }

    /***********************
     * RENDER
     ***********************/
    function metric(k, v) {
      return `
        <div class="pill rounded-lg px-3 py-2">
          <div class="k">${k}</div>
          <div class="v mono">${v}</div>
        </div>
      `;
    }

    function render() {
      const top5 = pickTop5();
      panel.innerHTML = "";

      if (!top5.length) {
        panel.innerHTML = `<div class="card rounded-xl p-4 small">ç›®å‰æ²’æœ‰è¶³å¤ è³‡æ–™æˆ–æ¢ä»¶å¤ªåš´ï¼Œè«‹ç¨ç­‰å¹¾è¼ªæƒæã€‚</div>`;
        return;
      }

      for (let idx=0; idx<top5.length; idx++) {
        const st = top5[idx];
        const b = stageBadge(st.stage);

        const isLocked = (st.symbol === S.locked);
        const rankBadge = idx === 0 ? "ğŸ† ç¬¬1å" : ("ç¬¬" + (idx+1) + "å");

        const ai = st.ai || {};
        const aiHas = !!ai.obj;
        const aiTxt = aiHas ? formatAIChinese(ai.obj) : (ai.lastErr ? ("ï¼ˆAIéŒ¯èª¤ï¼‰" + ai.lastErr) : "å°šæœªåˆ†æï¼šæŒ‰å³ä¸Šã€Analyzeã€‘æˆ–ã€Analyze Top3ã€‘");

        const aiMeta = [];
        if (ai.lastAt) aiMeta.push("AI@" + new Date(ai.lastAt).toLocaleTimeString("zh-TW",{hour12:false}));
        if (ai.cooldownUntil && Date.now() < ai.cooldownUntil) aiMeta.push("å†·å»ä¸­");
        if (Date.now() < S.globalCooldownUntil) aiMeta.push("å…¨ç«™å†·å»(429)");

        const card = document.createElement("div");
        card.className = `card rounded-xl p-4 ${isLocked ? "lock" : ""}`;

        card.innerHTML = `
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="text-white font-black text-lg">${st.symbol}</div>
              <span class="badge ${b.cls}">${b.text}</span>
              ${isLocked ? `<span class="badge border-emerald-500/50 text-emerald-300 bg-emerald-500/10">âœ… æœ€å¼·é–å®š</span>` : ``}
              <span class="badge">${rankBadge}</span>
              <span class="badge mono">score ${fmtNum(st.scoreSmooth,2)}</span>
            </div>

            <div class="flex items-center gap-2">
              <button class="btn2 px-3 py-2 rounded text-[12px] font-bold" data-act="analyze" data-sym="${st.symbol}">Analyzeï¼ˆGeminiï¼‰</button>
            </div>
          </div>

          <div class="mt-2 small">ç†ç”±ï¼š${st.stageReason || "-"}</div>

          <div class="mt-3 grid2 gap-3">
            <!-- LEFT: metrics -->
            <div class="grid3">
              ${metric("è·é›¢20é«˜é»(%)", fmtNum(st.last.toHighPct,3))}
              ${metric("1mé‡/20mä¸­ä½æ•¸", fmtNum(st.last.vol1mRatio,2))}
              ${metric("1mé‡Z(ç›¸å°20m)", fmtNum(st.last.vol1mZ,2))}

              ${metric("ä¸»å‹•è²·å…¥å·®é¡(1m,é‡‘é¡)", st.last.activeDiff1m!==null?fmtNum(st.last.activeDiff1m,0):"-")}
              ${metric("ä¸»å‹•è²·å…¥å·®é¡(5m,é‡‘é¡)", st.last.activeDiff5m!==null?fmtNum(st.last.activeDiff5m,0):"-")}
              ${metric("ä¸»å‹•è²·å…¥æ¯”ä¾‹(5m)", st.last.activeRatio5m!==null?fmtNum(st.last.activeRatio5m,3):"-")}

              ${metric("æ³¢å‹•/é‡ç•°å¸¸ Z(5m)", fmtNum(st.last.volZ,2))}
              ${metric("5åˆ†é˜æ¼²è·Œ", fmtPct(st.last.ret5m,2))}
              ${metric("è³‡é‡‘è²»ç‡(%)", fmtNum(st.last.fund,2))}

              ${metric("OI è®ŠåŒ–(5m)", st.last.oi5mChg!==null?fmtNum(st.last.oi5mChg,2):"-")}
              ${metric("OI ç•°å¸¸ Z(5m)", fmtNum(st.last.oiZ5,2))}
              ${metric("OI è®ŠåŒ–(4h)", st.last.oi4hChg!==null?fmtNum(st.last.oi4hChg,2):"-")}

              ${metric("è¶¨å‹¢(EMA20>EMA50 ä¸” åƒ¹åœ¨EMA20ä¸Š)", st.last.trendOk ? "âœ…" : "â€”")}
              ${metric("å€é–“é«˜(20)", fmtNum(st.last.range20High,6))}
              ${metric("ç¾åƒ¹", fmtNum(st.last.price,6))}
            </div>

            <!-- RIGHT: AI -->
            <div class="aiBox rounded-xl p-3">
              <div class="flex items-center justify-between">
                <div class="aiTitle">AI åˆ¤è®€ï¼ˆä¸­æ–‡ï¼‰</div>
                <div class="small mono">${aiMeta.join(" Â· ")}</div>
              </div>
              <div class="mt-2 text-[12px] leading-relaxed whitespace-pre-wrap">${aiTxt}</div>
            </div>
          </div>
        `;

        panel.appendChild(card);
      }

      // äº‹ä»¶ç¶å®š
      panel.querySelectorAll("button[data-act='analyze']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const sym = btn.getAttribute("data-sym");
          await analyzeOne(sym, true); // æ‰‹å‹•ï¼šæ°¸é é€
          render();
        });
      });
    }

    /***********************
     * GEMINI
     ***********************/
    function buildPromptForGemini(st) {
      const L = st.last;

      // åªä¸Ÿç²¾ç°¡æ‘˜è¦ï¼ˆé¿å… token çˆ†ï¼‰
      const summary = {
        symbol: st.symbol,
        onlyLong: true,
        goal: "pre-break 1-3 minutes before upside breakout",
        stage: st.stage,
        stageReason: st.stageReason,

        price: L.price,
        ret5m_pct: L.ret5m,

        // C æ¨¡å¼æ ¸å¿ƒ
        toHighPct_20: L.toHighPct,
        vol1mRatio_vs20mMedian: L.vol1mRatio,
        vol1mZ_vs20m: L.vol1mZ,
        activeDiff1m_quote: L.activeDiff1m,

        // flow / anomalies
        volZ_5m: L.volZ,
        activeBuyRatio_5m: L.activeRatio5m,
        activeBuyDiff_5m_quote: L.activeDiff5m,
        activeBuyRatio_4h: L.activeRatio4h,
        activeBuyDiff_4h_quote: L.activeDiff4h,

        // OI
        oi_now: L.oiNow,
        oi_change_5m: L.oi5mChg,
        oi_change_4h: L.oi4hChg,
        oiZ_5m: L.oiZ5,

        // funding / premium
        funding_pct: L.fund,
        premium_pct: L.premium,

        trendOk: !!L.trendOk,
        range20_high: L.range20High,

        antiChase_ret5m_max: CHASE_RET5M_MAX,
        prebreak_toHigh_max: PREBREAK_TO_HIGH_MAX_PCT,
      };

      return `
ä½ æ˜¯åˆç´„çŸ­ç·šã€Œåªåšå¤šã€ç›¤å‹¢åˆ¤è®€å¼•æ“ã€‚è«‹æ ¹æ“šæˆ‘çµ¦çš„ç²¾ç°¡æ•¸æ“šï¼Œè¼¸å‡ºã€Œåš´æ ¼ JSONã€ä¸”åªèƒ½å› JSONï¼ˆä¸è¦ä»»ä½•å¤šé¤˜æ–‡å­—ã€ä¸è¦ markdownï¼‰ã€‚

ä»»å‹™ï¼šåˆ¤æ–·æ­¤å¹£æ˜¯å¦è™•æ–¼ã€Œçªç ´å‰ 1~3 åˆ†é˜ã€çš„å¤šæ–¹æ©Ÿæœƒï¼ˆpre-breakï¼‰ï¼Œä¸¦è¼¸å‡ºï¼š
- symbolï¼ˆå­—ä¸²ï¼‰
- æ–¹å‘ï¼ˆåªå…è¨±ï¼šåšå¤š / è§€æœ› / ä¸åšï¼‰
- ä¿¡å¿ƒï¼ˆ0~100ï¼‰
- ç‹€æ…‹ï¼ˆåªå…è¨±ï¼šè“„å‹¢ / é»ç« / è§¸ç™¼ / ç„¡ï¼‰
- é è¨ˆè¡¨æ…‹ï¼ˆç‰©ä»¶ï¼š{min,max} å–®ä½åˆ†é˜ï¼Œè‹¥ä¸åšå‰‡å› {min:"-",max:"-"}ï¼‰
- åˆ†æ•¸ï¼ˆ0~100ï¼Œé€™æ˜¯ä½ è‡ªå·±çš„è©•åˆ†ï¼‰
- é€²å ´ï¼ˆç‰©ä»¶ï¼š{type:"é™åƒ¹/å¸‚åƒ¹", entry_low, entry_high, plan}ï¼‰
- åœæï¼ˆæ•¸å­—æˆ–å­—ä¸²ï¼‰
- æ­¢ç›ˆï¼ˆé™£åˆ—ï¼š["TP1 ...","TP2 ..."]ï¼‰
- å¤±æ•ˆæ¢ä»¶ï¼ˆé™£åˆ—ï¼‰
- ç†ç”±è¦é»ï¼ˆé™£åˆ—ï¼ŒçŸ­å¥ï¼‰
- é¢¨éšªæé†’ï¼ˆé™£åˆ—ï¼‰

ç´„æŸï¼ˆå¾ˆé‡è¦ï¼‰ï¼š
1) åªåšå¤šï¼šä¸è¦æä¾›åšç©ºç­–ç•¥ã€‚
2) anti-chaseï¼šå¦‚æœ ret5m å·²æ¥è¿‘/è¶…é antiChase_ret5m_max æˆ– funding éç†±ï¼Œè«‹æ›´ä¿å®ˆã€‚
3) pre-break æ ¸å¿ƒï¼štoHighPct_20 è¶Šå°è¶Šæ¥è¿‘çªç ´ï¼›vol1mRatio/vol1mZ æŠ¬å‡ä»£è¡¨é»ç«ï¼›activeDiff1m_quote > 0 æ˜¯é—œéµã€‚
4) ä¸è¦è¼¸å‡º nullï¼›ç¼ºå€¼ç”¨ "-"ã€‚

è¼¸å…¥æ•¸æ“š(JSON)ï¼š
${JSON.stringify(summary)}
`.trim();
    }

    async function geminiGenerateJSON(prompt) {
      const now = Date.now();
      if (now < S.globalCooldownUntil) {
        return { ok:false, status:429, err:"å…¨ç«™å†·å»ä¸­ï¼ˆå‰›å‰› 429ï¼‰" };
      }
      if (!S.key) return { ok:false, status:401, err:"æœªè¨­å®š Gemini Key" };

      // å…¨åŸŸé–“éš”
      const gap = now - S.lastGeminiAt;
      if (gap < GLOBAL_MIN_GAP_MS) await new Promise(r=>setTimeout(r, GLOBAL_MIN_GAP_MS - gap));

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent`;
      const body = {
        system_instruction: { parts: [{ text: "ä½ åªè¼¸å‡º JSONã€‚åªèƒ½å› JSONã€‚ä¸å¯åŠ ä»»ä½•å¤šé¤˜æ–‡å­—ã€‚" }] },
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          maxOutputTokens: MAX_OUTPUT_TOKENS,
          temperature: 0.25,
          responseMimeType: "application/json"
        }
      };

      S.lastGeminiAt = Date.now();

      const r = await fetch(url, {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          "x-goog-api-key": S.key,
        },
        body: JSON.stringify(body)
      });

      if (r.status === 429) {
        S.globalCooldownUntil = Date.now() + COOLDOWN_ON_429_MS;
        updateKeyUi();
      }

      const txt = await r.text();
      let data = null;
      try { data = JSON.parse(txt); } catch(e) { data = { _raw: txt }; }

      if (!r.ok) {
        const msg = (data && data.error && data.error.message) ? data.error.message : txt;
        return { ok:false, status:r.status, err: msg };
      }

      const out = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!out) return { ok:false, status:500, err:"Gemini å›å‚³æ ¼å¼ç•°å¸¸ï¼šæ‰¾ä¸åˆ° candidates[0].content.parts[0].text" };

      const parsed = safeParseJSON(out);
      if (!parsed) return { ok:false, status:200, err:"Gemini æ²’å›æœ‰æ•ˆ JSONï¼ˆå·²è¦æ±‚ JSON modeï¼‰", raw: out };

      return { ok:true, status:200, obj: parsed };
    }

    function safeParseJSON(s) {
      if (!s) return null;
      const i = s.indexOf("{");
      const j = s.lastIndexOf("}");
      if (i >= 0 && j > i) {
        const sub = s.slice(i, j+1);
        try { return JSON.parse(sub); } catch(e) {}
      }
      try { return JSON.parse(s); } catch(e) {}
      return null;
    }

    function normalizeAI(obj, fallbackSymbol) {
      const o = obj || {};
      const get = (k, d="-") => (o[k]===undefined || o[k]===null || o[k]==="") ? d : o[k];
      return {
        symbol: get("symbol", fallbackSymbol),
        æ–¹å‘: get("æ–¹å‘", get("bias","è§€æœ›")),
        ä¿¡å¿ƒ: get("ä¿¡å¿ƒ", get("confidence", 0)),
        ç‹€æ…‹: get("ç‹€æ…‹", get("state","-")),
        åˆ†æ•¸: get("åˆ†æ•¸", get("score","-")),
        é è¨ˆè¡¨æ…‹: get("é è¨ˆè¡¨æ…‹", get("eta","-")),
        é€²å ´: get("é€²å ´", get("entry","-")),
        åœæ: get("åœæ", get("stop","-")),
        æ­¢ç›ˆ: get("æ­¢ç›ˆ", get("takeProfit", [])),
        å¤±æ•ˆæ¢ä»¶: get("å¤±æ•ˆæ¢ä»¶", get("invalidations", [])),
        ç†ç”±è¦é»: get("ç†ç”±è¦é»", get("reasons", [])),
        é¢¨éšªæé†’: get("é¢¨éšªæé†’", get("risks", [])),
      };
    }

    function formatAIChinese(obj) {
      const o = normalizeAI(obj, "-");

      const eta = (typeof o.é è¨ˆè¡¨æ…‹ === "object" && o.é è¨ˆè¡¨æ…‹)
        ? `${o.é è¨ˆè¡¨æ…‹.min ?? "-"}~${o.é è¨ˆè¡¨æ…‹.max ?? "-"} åˆ†é˜`
        : String(o.é è¨ˆè¡¨æ…‹);

      const tp = Array.isArray(o.æ­¢ç›ˆ) ? o.æ­¢ç›ˆ : [];
      const inv = Array.isArray(o.å¤±æ•ˆæ¢ä»¶) ? o.å¤±æ•ˆæ¢ä»¶ : [];
      const rs = Array.isArray(o.ç†ç”±è¦é») ? o.ç†ç”±è¦é» : [];
      const rk = Array.isArray(o.é¢¨éšªæé†’) ? o.é¢¨éšªæé†’ : [];

      return [
        `æ–¹å‘ï¼š${o.æ–¹å‘}ã€€|ã€€ä¿¡å¿ƒï¼š${o.ä¿¡å¿ƒ}/100ã€€|ã€€åˆ†æ•¸ï¼š${o.åˆ†æ•¸}/100`,
        `ç‹€æ…‹ï¼š${o.ç‹€æ…‹}`,
        `é è¨ˆè¡¨æ…‹ï¼š${eta}`,
        `é€²å ´ï¼š${typeof o.é€²å ´ === "object" ? JSON.stringify(o.é€²å ´) : o.é€²å ´}`,
        `åœæï¼š${typeof o.åœæ === "object" ? JSON.stringify(o.åœæ) : o.åœæ}`,
        `æ­¢ç›ˆï¼š${tp.length ? tp.join(" / ") : "-"}`,
        `å¤±æ•ˆæ¢ä»¶ï¼š${inv.length ? inv.join(" / ") : "-"}`,
        `ç†ç”±ï¼š${rs.length ? ("\n- " + rs.join("\n- ")) : "-"}`,
        rk.length ? (`é¢¨éšªï¼š\n- ${rk.join("\n- ")}`) : ""
      ].filter(Boolean).join("\n");
    }

    async function analyzeOne(symbol, manual=false) {
      const st = S.symbols.get(symbol);
      if (!st) return;

      if (!S.key) {
        st.ai.lastErr = "æœªè¨­å®š Gemini Key";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        updateKeyUi();
        return;
      }

      // per-symbol cooldownï¼ˆæ‰‹å‹•ä¹Ÿè¦å†·å»ï¼‰
      const now = Date.now();
      if (st.ai.cooldownUntil && now < st.ai.cooldownUntil) {
        st.ai.lastErr = "å†·å»ä¸­ï¼Œç¨å¾Œå†è©¦";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        return;
      }
      if (st.ai.lastAt && (now - st.ai.lastAt < PER_SYMBOL_COOLDOWN_MS)) {
        st.ai.lastErr = "åŒå¹£å†·å»ä¸­ï¼ˆ60sï¼‰";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        return;
      }

      // Autoï¼šåªåœ¨ ğŸŸ§ é»ç« æ‰é€ï¼ˆä½ é¸ C çš„æ ¸å¿ƒï¼‰
      if (!manual) {
        if (!(st.stage === "IGNITE")) return;
      }

      st.ai.lastErr = "";
      st.ai.lastOk = false;
      st.ai.obj = null;
      S.symbols.set(symbol, st);
      render();

      setStatus(`Gemini é€å‡ºï¼š${symbol} ...`);
      updateKeyUi();

      const prompt = buildPromptForGemini(st);
      const res = await geminiGenerateJSON(prompt);

      if (!res.ok) {
        st.ai.lastAt = Date.now();
        st.ai.lastOk = false;
        st.ai.lastErr = `HTTP ${res.status}: ${res.err || "error"}`;
        st.ai.cooldownUntil = Date.now() + 8000;
        S.symbols.set(symbol, st);
        if (res.status === 429) setStatus(`Gemini 429ï¼šå…¨ç«™å†·å» ${Math.round(COOLDOWN_ON_429_MS/60000)} åˆ†é˜`);
        else setStatus(`Gemini FAILï¼š${symbol}ï¼ˆ${res.status}ï¼‰`);
        updateKeyUi();
        return;
      }

      st.ai.lastAt = Date.now();
      st.ai.lastOk = true;
      st.ai.lastErr = "";
      st.ai.obj = normalizeAI(res.obj, symbol);
      st.ai.cooldownUntil = Date.now() + 2000;
      S.symbols.set(symbol, st);

      S.keyOk = true;
      S.keyLastOkAt = Date.now();
      setStatus(`Gemini OKï¼š${symbol}`);
      updateKeyUi();
    }

    async function analyzeTop3() {
      const top = pickTop5().slice(0, TOPK_ANALYZE);
      for (const st of top) {
        await analyzeOne(st.symbol, true); // æ‰‹å‹•ï¼šæ°¸é é€
        await new Promise(r=>setTimeout(r, 200));
      }
      render();
    }

    async function testGemini() {
      if (!S.key) { setStatus("å…ˆè²¼ Key å† Test"); updateKeyUi(); return; }

      setStatus("Test Gemini ...");
      const prompt = `åªå› JSONï¼š{"ok":true,"msg":"pong"}ï¼ˆåªèƒ½ JSONï¼Œä¸è¦ä»»ä½•å­—ï¼‰`;
      const res = await geminiGenerateJSON(prompt);

      if (!res.ok) {
        setStatus(`Test FAILï¼ˆHTTP ${res.status}ï¼‰ï¼š${res.err || ""}`);
        updateKeyUi();
        return;
      }

      S.keyOk = true;
      S.keyLastOkAt = Date.now();
      setStatus("Test OKï¼šGemini å¯ç”¨");
      updateKeyUi();
      alert("Test OKï¼šGemini å¯ç”¨ï¼ˆä½ ä¹Ÿå¯ä»¥é–‹ DevTools â†’ Network çœ‹è«‹æ±‚æ˜¯å¦æˆåŠŸï¼‰");
    }

    /***********************
     * LOOPS
     ***********************/
    async function scanTick() {
      if (!S.universe.length) return;

      // round-robinï¼šæ¯æ¬¡åªæ›´æ–°ä¸€å°æ‰¹
      const BATCH = 8;
      const batch = [];
      for (let i=0;i<BATCH;i++) {
        const sym = S.universe[(S.rrIdx + i) % S.universe.length];
        batch.push(sym);
      }
      S.rrIdx = (S.rrIdx + BATCH) % S.universe.length;

      await Promise.all(batch.map(sym => updateSymbol(sym)));

      $("lastUpdate").innerText = nowHHMMSS();
      updateKeyUi();
      render();
    }

    function startAutoGemini() {
      setInterval(async ()=>{
        if (!$("autoToggle").checked) return;
        if (!S.key) return;
        if (Date.now() < S.globalCooldownUntil) return;

        // åªåœ¨ top5 å·²ç¶“æœ‰ 5 æ”¯ï¼Œä¸”è‡³å°‘ä¸€æ”¯åœ¨ ğŸŸ§ æ‰è‡ªå‹•æ‰“
        const top5 = pickTop5();
        if (top5.length < 5) return;
        const hot = top5.filter(x => x.stage === "IGNITE");
        if (!hot.length) return;

        setStatus("Auto Geminiï¼šåªæ‰“ Top3 ä¸”åƒ… ğŸŸ§ é»ç« ...");
        for (const st of top5.slice(0, TOPK_ANALYZE)) {
          await analyzeOne(st.symbol, false); // autoï¼šå…§éƒ¨ gate åªé€ ğŸŸ§
        }
        render();
      }, AUTO_INTERVAL_MS);
    }

    /***********************
     * EVENTS
     ***********************/
    $("btnSaveKey").addEventListener("click", saveKeyFromInput);
    $("btnClearKey").addEventListener("click", clearKey);
    $("btnTestGemini").addEventListener("click", testGemini);
    $("btnAnalyzeTop").addEventListener("click", analyzeTop3);
    $("btnReset").addEventListener("click", ()=>{
      S.symbols.clear();
      S.locked = null;
      setStatus("Reset done");
      render();
    });

    /***********************
     * BOOT
     ***********************/
    (async function boot(){
      loadKey();
      setStatus("Booting ...");
      await refreshUniverse();
      await scanTick();
      setInterval(scanTick, SCAN_INTERVAL_MS);
      startAutoGemini();
      setStatus("Running");
    })();
  </script>
</body>
</html>
