<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRIDENT V7 - Anomaly-first Long Scanner + Gemini</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#050505; color:#d4d4d8; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .card { background:#0f0f11; border:1px solid #1f1f23; }
    .pill { border:1px solid #27272a; background:#0b0b0d; }
    .k { color:#a1a1aa; font-size:11px; }
    .v { color:#e5e7eb; font-weight:700; font-size:12px; }
    .stage-setup { background: rgba(234,179,8,.14); border-color: rgba(234,179,8,.5); color:#fbbf24; }
    .stage-ignite { background: rgba(249,115,22,.14); border-color: rgba(249,115,22,.5); color:#fb923c; }
    .stage-confirm { background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.5); color:#4ade80; }
    .stage-none { background: rgba(148,163,184,.10); border-color: rgba(148,163,184,.25); color:#94a3b8; }
    .lock { border:2px solid #22c55e !important; box-shadow:0 0 20px rgba(34,197,94,.10); }
    .badge { font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2f; }
    .btn { background:#111827; border:1px solid #374151; color:#e5e7eb; }
    .btn:hover { background:#1f2937; }
    .btn2 { background:#0b1220; border:1px solid #1d4ed8; color:#93c5fd; }
    .btn2:hover { background:#172554; }
    .btnDanger { background:#1a0a0a; border:1px solid #ef4444; color:#fecaca; }
    .btnDanger:hover { background:#2a0b0b; }
    .dot { width:9px; height:9px; border-radius:999px; display:inline-block; }
    .dotGray { background:#52525b; box-shadow:none; }
    .dotAmber { background:#f59e0b; box-shadow:0 0 10px rgba(245,158,11,.55); }
    .dotGreen { background:#22c55e; box-shadow:0 0 10px rgba(34,197,94,.55); }
    .dotRed { background:#ef4444; box-shadow:0 0 10px rgba(239,68,68,.55); }
    .mono { font-variant-numeric: tabular-nums; }
    .small { font-size:11px; color:#a1a1aa; }
    .aiBox { background:#070709; border:1px solid #222227; }
    .aiTitle { font-weight:900; color:#fff; }
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
  </style>
</head>

<body class="p-4">
  <!-- Header -->
  <div class="flex flex-col gap-3 mb-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <span id="gemDot" class="dot dotGray"></span>
        <div>
          <div class="text-xl font-black italic text-white">TRIDENT <span class="text-emerald-400">V7</span></div>
          <div class="small">Anomaly-first LONG scanner â†’ Top5ï¼ˆæœ€å¼·é–å®šç½®é ‚ï¼‰â†’ Geminiï¼ˆTop3 onlyï¼‰</div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <input id="keyInput" type="password" placeholder="è²¼ä¸Š Gemini API Keyï¼ˆä¸æœƒä¸Šå‚³åˆ°æˆ‘çš„ä¼ºæœå™¨ï¼‰"
          class="w-[360px] max-w-full bg-zinc-900 border border-zinc-700 text-[12px] px-3 py-2 rounded text-white outline-none" />
        <button id="btnSaveKey" class="btn px-3 py-2 rounded text-[12px] font-bold">Save</button>
        <button id="btnClearKey" class="btnDanger px-3 py-2 rounded text-[12px] font-bold">Clear</button>

        <button id="btnTestGemini" class="btn2 px-3 py-2 rounded text-[12px] font-bold">Test Gemini</button>
        <button id="btnAnalyzeTop" class="btn2 px-3 py-2 rounded text-[12px] font-bold">Analyze Top3 (Gemini)</button>

        <label class="flex items-center gap-2 text-[12px] select-none">
          <input id="autoToggle" type="checkbox" class="accent-emerald-500" />
          Autoï¼ˆåªåœ¨ğŸŸ§/ğŸŸ©æ‰æ‰“ï¼‰
        </label>

        <button id="btnReset" class="btn px-3 py-2 rounded text-[12px] font-bold">RESET</button>
      </div>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-2">
      <div class="small mono" id="statusLine">status: -</div>
      <div class="small mono">
        æ›´æ–°ï¼š<span id="lastUpdate">-</span>ã€€|ã€€
        æ¨¡å‹ï¼š<span id="modelName">gemini-2.5-flash</span>ã€€|ã€€
        max_outï¼š<span id="maxOut">420</span>ã€€|ã€€
        TopKï¼š<span id="topK">3</span>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="card rounded-xl p-4 mb-4">
    <div class="flex items-center justify-between">
      <div class="text-white font-black">Top 5 å€™é¸ï¼ˆæœ€å¼·é–å®šç½®é ‚ï¼‰</div>
      <div class="small mono">Universeï¼š<span id="univN">-</span>ã€€|ã€€Readyï¼š<span id="readyN">-</span></div>
    </div>
  </div>

  <div id="panel" class="flex flex-col gap-3"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const BINANCE = "https://fapi.binance.com";
    const MODEL = "gemini-2.5-flash";          // ä½ è¦æ›ä¹Ÿè¡Œ
    const MAX_OUTPUT_TOKENS = 420;             // ä½ èªªçš„ max_output_tokens
    const TOPK_ANALYZE = 3;                    // åªåˆ†æ Top3
    const AUTO_INTERVAL_MS = 120000;           // 2 åˆ†é˜
    const SCAN_INTERVAL_MS = 6000;             // æƒæç¯€å¥ï¼ˆåˆ¥å¤ªå¿«ï¼Œé¿å… Binance rate limitï¼‰
    const UNIVERSE_SIZE = 80;                  // åªå–æˆäº¤é¡å¤§çš„å‰ 80 ç•¶ universeï¼ˆé¿å…å…¨å¸‚å ´çˆ†è«‹æ±‚ï¼‰
    const EXCLUDE = new Set(["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]);

    // åªåšå¤šï¼šè¶¨å‹¢/è¿½é«˜æ§åˆ¶ï¼ˆä½ å¯å†èª¿ï¼‰
    const CHASE_RET5M_MAX = 1.20;              // 5m æ¼²å¤ªå¤š â†’ è¿½é«˜æ‡²ç½°
    const REQUIRE_BULL_TREND = true;           // trueï¼šåªè¦ EMA20>EMA50 ä¸” åƒ¹åœ¨ EMA20 ä¸Šæ‰åŠ åˆ†

    // Gemini ç¯€æµ
    const PER_SYMBOL_COOLDOWN_MS = 60000;      // åŒä¸€å¹£ 60 ç§’å…§ä¸é‡æ‰“
    const GLOBAL_MIN_GAP_MS = 1400;            // Gemini é€£æ‰“é–“éš”ï¼ˆé¿å…ç¬é–“ 429ï¼‰
    const COOLDOWN_ON_429_MS = 5 * 60 * 1000;  // æ’ 429 å°±å…¨ç«™å†·å» 5 åˆ†é˜

    /***********************
     * STATE
     ***********************/
    const S = {
      key: "",
      keyOk: false,
      keyLastOkAt: 0,
      globalCooldownUntil: 0,
      lastGeminiAt: 0,

      universe: [],
      rrIdx: 0,
      symbols: new Map(),     // symbol -> data
      locked: null,           // é–å®šæœ€å¼·
      lastRender: 0,
    };

    /***********************
     * DOM
     ***********************/
    const $ = (id) => document.getElementById(id);
    const panel = $("panel");

    function setStatus(t) { $("statusLine").innerText = "status: " + t; }
    function setDot(mode) {
      const d = $("gemDot");
      d.className = "dot " + (mode==="green" ? "dotGreen" : mode==="amber" ? "dotAmber" : mode==="red" ? "dotRed" : "dotGray");
    }
    function fmtPct(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      return (x >= 0 ? "+" : "") + x.toFixed(dp) + "%";
    }
    function fmtNum(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(x)) return "-";
      return Number(x).toFixed(dp);
    }
    function nowHHMMSS() {
      const d = new Date();
      return d.toLocaleTimeString("zh-TW",{hour12:false});
    }

    /***********************
     * STORAGE: KEY
     ***********************/
    function loadKey() {
      const k = localStorage.getItem("TRIDENT_GEMINI_KEY") || "";
      S.key = k;
      $("keyInput").value = k ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "";
      updateKeyUi();
    }
    function saveKeyFromInput() {
      // åªå­˜ä½ è¼¸å…¥çš„åŸå§‹ keyï¼šå¦‚æœä½ çœ‹åˆ°çš„æ˜¯ â€¢â€¢â€¢â€¢ï¼Œä»£è¡¨ä½ æ²’é‡æ–°è²¼ä¸Š
      const raw = $("keyInput").value.trim();
      if (!raw || raw.includes("â€¢â€¢â€¢â€¢")) {
        setStatus("è«‹é‡æ–°è²¼ä¸Šå®Œæ•´ Keyï¼ˆä¸è¦æ˜¯ â€¢â€¢â€¢â€¢ï¼‰");
        return;
      }
      S.key = raw;
      localStorage.setItem("TRIDENT_GEMINI_KEY", raw);
      $("keyInput").value = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
      setStatus("Key saved");
      updateKeyUi();
    }
    function clearKey() {
      S.key = "";
      S.keyOk = false;
      S.keyLastOkAt = 0;
      localStorage.removeItem("TRIDENT_GEMINI_KEY");
      $("keyInput").value = "";
      setStatus("Key cleared");
      updateKeyUi();
    }
    function updateKeyUi() {
      if (!S.key) { setDot("gray"); return; }
      if (Date.now() < S.globalCooldownUntil) { setDot("red"); return; }
      if (S.keyOk && (Date.now() - S.keyLastOkAt < 5*60*1000)) setDot("green");
      else setDot("amber");
    }

    /***********************
     * BINANCE FETCH
     ***********************/
    async function fetchJSON(url, timeoutMs=8000) {
      const ac = new AbortController();
      const t = setTimeout(() => ac.abort(), timeoutMs);
      try {
        const r = await fetch(url, { signal: ac.signal });
        const txt = await r.text();
        let j = null;
        try { j = JSON.parse(txt); } catch(e) { j = { _raw: txt }; }
        return { ok: r.ok, status: r.status, data: j };
      } catch (e) {
        return { ok: false, status: 0, data: { error: String(e) } };
      } finally {
        clearTimeout(t);
      }
    }

    async function refreshUniverse() {
      const r = await fetchJSON(`${BINANCE}/fapi/v1/ticker/24hr`);
      if (!r.ok || !Array.isArray(r.data)) {
        setStatus("Binance 24hr tickers è®€å–å¤±æ•—");
        return;
      }
      const all = r.data
        .filter(x => x.symbol && x.symbol.endsWith("USDT") && !EXCLUDE.has(x.symbol))
        .map(x => ({
          symbol: x.symbol,
          qv: Number(x.quoteVolume || 0),
        }))
        .filter(x => x.qv > 5_000_000)      // å¤ªå°çš„è·³éï¼Œé¿å…æµªè²»
        .sort((a,b) => b.qv - a.qv)
        .slice(0, UNIVERSE_SIZE)
        .map(x => x.symbol);

      S.universe = all;
      $("univN").innerText = String(all.length);
      setStatus("Universe refreshed: " + all.length);
    }

    function ema(values, period) {
      if (values.length < period) return null;
      const k = 2 / (period + 1);
      let e = values[0];
      for (let i=1;i<values.length;i++) e = values[i]*k + e*(1-k);
      return e;
    }

    function meanStd(arr) {
      if (!arr.length) return { m:0, s:0 };
      const m = arr.reduce((a,b)=>a+b,0)/arr.length;
      const v = arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
      return { m, s: Math.sqrt(v) };
    }

    function zscore(x, m, s) {
      if (!s || s === 0) return 0;
      return (x - m)/s;
    }

    // æ ¸å¿ƒï¼šæŠ“ä¸€å€‹ symbol çš„ 1m K ç·š + funding/premium + OI
    async function updateSymbol(symbol) {
      const st = S.symbols.get(symbol) || {
        symbol,
        score: 0,
        scoreSmooth: 0,
        stage: "NONE",
        stageReason: "",
        last: {},
        hist: {
          vol5m: [],
          ret5m: [],
          oi: [],
          tsOi: [],
        },
        ai: {
          lastAt: 0,
          lastOk: false,
          lastErr: "",
          cooldownUntil: 0,
          obj: null
        }
      };

      const [k, p, oi] = await Promise.all([
        fetchJSON(`${BINANCE}/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=240`, 9000),
        fetchJSON(`${BINANCE}/fapi/v1/premiumIndex?symbol=${symbol}`, 7000),
        fetchJSON(`${BINANCE}/fapi/v1/openInterest?symbol=${symbol}`, 7000),
      ]);

      if (!k.ok || !Array.isArray(k.data)) {
        st.last.err = "klines fail";
        S.symbols.set(symbol, st);
        return;
      }

      const kl = k.data;
      const closes = kl.map(x => Number(x[4]));
      const highs  = kl.map(x => Number(x[2]));
      const lows   = kl.map(x => Number(x[3]));
      const quoteV = kl.map(x => Number(x[7]));   // quote asset volume
      const takerQ = kl.map(x => Number(x[10]));  // taker buy quote volume

      const lastC = closes[closes.length-1];
      const c_5m  = closes[closes.length-6] ?? closes[0];
      const ret5m = (lastC - c_5m) / c_5m * 100;

      // 5m æˆäº¤é¡èˆ‡ç•°å¸¸ï¼ˆè·Ÿè‡ªå·± 4h çš„ 5m åˆ†ä½ˆæ¯”ï¼‰
      const win5mQuote = [];
      for (let i=0;i<240;i+=5) {
        const s = quoteV.slice(i,i+5).reduce((a,b)=>a+b,0);
        win5mQuote.push(s);
      }
      const last5mVol = quoteV.slice(-5).reduce((a,b)=>a+b,0);
      const msVol = meanStd(win5mQuote.slice(0,-1)); // ä¸å«æœ€å¾Œä¸€æ®µé¿å…è‡ªæˆ‘æ±¡æŸ“
      const volZ = zscore(last5mVol, msVol.m, msVol.s);

      // ä¸»å‹•è²·å…¥å·®é¡ï¼ˆ5m / 4hï¼‰ï¼š(takerBuyQuote - takerSellQuote) = 2*takerBuyQuote - totalQuote
      const sumQ5 = quoteV.slice(-5).reduce((a,b)=>a+b,0);
      const sumT5 = takerQ.slice(-5).reduce((a,b)=>a+b,0);
      const activeDiff5m = (2*sumT5 - sumQ5);                 // é‡‘é¡æ­£ â†’ ä¸»å‹•è²·å¤š
      const activeRatio5m = sumQ5 > 0 ? (sumT5 / sumQ5) : null;

      const sumQ4 = quoteV.reduce((a,b)=>a+b,0);
      const sumT4 = takerQ.reduce((a,b)=>a+b,0);
      const activeDiff4h = (2*sumT4 - sumQ4);
      const activeRatio4h = sumQ4 > 0 ? (sumT4 / sumQ4) : null;

      // EMA è¶¨å‹¢ï¼ˆåªåšå¤šï¼‰
      const ema20 = ema(closes.slice(-60), 20);
      const ema50 = ema(closes.slice(-120), 50);
      const trendOk = (ema20 && ema50) ? (ema20 > ema50 && lastC >= ema20) : false;

      // Anti-chaseï¼šå™´å¤ªé«˜å°±æ‰£åˆ†
      const chasePenalty = Math.max(0, ret5m - CHASE_RET5M_MAX) * 8;

      // Premium / Funding
      let premiumPct = null, fundingPct = null;
      if (p.ok && p.data) {
        const mp = Number(p.data.markPrice || 0);
        const ip = Number(p.data.indexPrice || 0);
        premiumPct = (ip > 0) ? ((mp - ip) / ip * 100) : null;
        fundingPct = Number(p.data.lastFundingRate || 0) * 100;
      }

      // OIï¼š5m è®ŠåŒ– + 4h è®ŠåŒ–ï¼ˆç”¨å‰ç«¯å¿«ç…§ï¼Œä¸ç”¨ä¸€ç›´æ‰“ hist APIï¼‰
      const oiNow = (oi.ok && oi.data) ? Number(oi.data.openInterest || 0) : null;
      let oi5mChg = null;
      let oi4hChg = null;

      const tNow = Date.now();
      if (oiNow !== null) {
        st.hist.oi.push(oiNow);
        st.hist.tsOi.push(tNow);

        // 5m ä¹‹å‰çš„ snapshot
        const t5 = tNow - 5*60*1000;
        for (let i=st.hist.tsOi.length-1;i>=0;i--) {
          if (st.hist.tsOi[i] <= t5) { oi5mChg = oiNow - st.hist.oi[i]; break; }
        }

        // 4h ä¹‹å‰çš„ snapshot
        const t4 = tNow - 4*60*60*1000;
        for (let i=st.hist.tsOi.length-1;i>=0;i--) {
          if (st.hist.tsOi[i] <= t4) { oi4hChg = oiNow - st.hist.oi[i]; break; }
        }

        // æ§åˆ¶æ­·å²é•·åº¦ï¼ˆä¿ç•™ 6 å°æ™‚ï¼‰
        const tKeep = tNow - 6*60*60*1000;
        while (st.hist.tsOi.length && st.hist.tsOi[0] < tKeep) {
          st.hist.tsOi.shift(); st.hist.oi.shift();
        }
      }

      // OI ç•°å¸¸ï¼ˆè·Ÿè‡ªå·±æœ€è¿‘ 1 å°æ™‚çš„ 5m è®ŠåŒ–åˆ†ä½ˆæ¯”ï¼‰
      // é€™è£¡ç”¨ã€Œoi5mChgã€æœ¬èº«çš„ rolling Zï¼ˆå‰ç«¯è¦å…ˆç´¯ç©ï¼Œå‰›é–‹å§‹æœƒæ¥è¿‘ 0ï¼‰
      if (oi5mChg !== null) {
        st.hist.oi5m = st.hist.oi5m || [];
        st.hist.oi5m.push(oi5mChg);
        if (st.hist.oi5m.length > 120) st.hist.oi5m.shift();
      }
      const msOi = meanStd((st.hist.oi5m || []).slice(0,-1));
      const oiZ5 = (oi5mChg !== null) ? zscore(oi5mChg, msOi.m, msOi.s) : 0;

      // æˆäº¤é‡ç•°å¸¸ï¼ˆ5mï¼‰ï¼šè·Ÿè‡ªå·± 4h çš„ 5m åˆ†ä½ˆæ¯”
      const volZ5 = volZ;

      // å»ºç«‹ä¸‰æ®µç‡ˆè™Ÿï¼ˆåªåšå¤šï¼‰
      // Setupï¼šæ³¢å‹•/é‡ç•°å¸¸ + ä¸»å‹•è²·åå¤šï¼ˆæˆ–è‡³å°‘ä¸åç©ºï¼‰
      // Igniteï¼šSetup + OI 5m ç•°å¸¸æ­£å‘ æˆ– ä¸»å‹•è²·å·®é¡å¼·
      // Confirmï¼šIgnite + ç ´å€é–“/è¶¨å‹¢ç¢ºèªï¼ˆret5m å°å¹…æ­£ & ä¸è¿½é«˜ï¼‰
      const range20High = Math.max(...highs.slice(-20));
      const range20Low  = Math.min(...lows.slice(-20));
      const breakUp = lastC >= range20High * 0.999; // æ¥è¿‘çªç ´
      const notChasing = ret5m <= CHASE_RET5M_MAX;

      let stage = "NONE", stageReason = "";
      const activeBuyOk = (activeDiff5m !== null) ? (activeDiff5m > 0) : false;

      if (volZ5 >= 2.0 && (activeBuyOk || activeRatio5m >= 0.50)) {
        stage = "SETUP";
        stageReason = "é‡/æ³¢å‹•ç•°å¸¸ + ä¸»å‹•è²·åå¤š";
      }
      if (stage !== "NONE" && (oiZ5 >= 1.2 || activeDiff5m > msVol.m*0.08)) {
        stage = "IGNITE";
        stageReason = "åŠ ä¸Š OI/ä¸»å‹•è²·åŠ é€Ÿ";
      }
      if (stage === "IGNITE" && notChasing && (breakUp || ret5m > 0.10) && (!REQUIRE_BULL_TREND || trendOk)) {
        stage = "CONFIRM";
        stageReason = "è¶¨å‹¢/çªç ´ç¢ºèªä¸”ä¸è¿½é«˜";
      }

      // åˆ†æ•¸ï¼ˆåªåšå¤šï¼‰ï¼šæŠŠã€Œç•°å¸¸ã€æ”¾å¤§ï¼Œä½†è¿½é«˜æ‰£åˆ†ï¼›åç©ºçš„ ret5m<0 æœƒæ‰£
      let score =
        (volZ5 * 8) +
        (Math.max(0, oiZ5) * 5) +
        ((activeDiff5m > 0) ? 6 : -6) +
        ((activeRatio5m !== null) ? (activeRatio5m - 0.5) * 20 : 0) +
        (trendOk ? 6 : (REQUIRE_BULL_TREND ? -6 : 0)) +
        (ret5m > 0 ? 3 : -6) -
        chasePenalty;

      // stage åŠ æ¬Š
      if (stage === "SETUP") score += 4;
      if (stage === "IGNITE") score += 10;
      if (stage === "CONFIRM") score += 18;

      // å¹³æ»‘é¿å…è·³æ¦œ
      st.score = score;
      st.scoreSmooth = st.scoreSmooth ? (st.scoreSmooth*0.75 + score*0.25) : score;

      st.stage = stage;
      st.stageReason = stageReason;

      st.last = {
        price: lastC,
        ret5m,
        volZ: volZ5,
        fund: fundingPct,
        premium: premiumPct,
        activeDiff5m,
        activeDiff4h,
        activeRatio5m,
        activeRatio4h,
        oiNow,
        oi5mChg,
        oi4hChg,
        oiZ5,
        ema20, ema50, trendOk,
        range20High, range20Low,
      };

      S.symbols.set(symbol, st);
    }

    /***********************
     * CANDIDATES + LOCK
     ***********************/
    function stageBadge(stage) {
      if (stage === "SETUP") return { cls:"stage-setup", text:"ğŸŸ¨ è“„å‹¢ï¼ˆSetupï¼‰" };
      if (stage === "IGNITE") return { cls:"stage-ignite", text:"ğŸŸ§ é»ç«ï¼ˆIgniteï¼‰" };
      if (stage === "CONFIRM") return { cls:"stage-confirm", text:"ğŸŸ© è§¸ç™¼ï¼ˆConfirmï¼‰" };
      return { cls:"stage-none", text:"â¬› ç„¡" };
    }

    function pickTop5() {
      const arr = Array.from(S.symbols.values())
        .filter(x => x.last && x.last.price)
        .sort((a,b) => (b.scoreSmooth - a.scoreSmooth));

      // å…ˆæŒ‘å‰ 12ï¼Œå†å»é™¤æ˜é¡¯åç©ºï¼ˆret5m å¾ˆè² ã€ä¸»å‹•è²·å·®é¡è² ï¼‰â†’ åªåšå¤š
      const filtered = [];
      for (const x of arr) {
        const r = x.last.ret5m;
        const ad = x.last.activeDiff5m;
        // ä¸è¦é‚£ç¨®ã€Œè·Œæˆå–œæ†¨ã€ï¼šret5m < -0.15 ä¸” ä¸»å‹•è²·å·®é¡ <=0 â†’ ç›´æ¥ç•¥é
        if (r < -0.15 && ad !== null && ad <= 0) continue;
        filtered.push(x);
        if (filtered.length >= 12) break;
      }

      // æœ€çµ‚ Top5
      let top = filtered.slice(0,5);

      // é–å®šæœ€å¼·ï¼šé™¤éæœ‰äººã€Œæ˜é¡¯æ›´å¼·ã€ï¼ˆé«˜å‡º 8 åˆ†ï¼‰æ‰æ›
      if (!S.locked && top.length) S.locked = top[0].symbol;
      if (S.locked) {
        const lockedObj = top.find(x => x.symbol === S.locked) || S.symbols.get(S.locked);
        const best = top[0];
        if (lockedObj && best && best.symbol !== S.locked) {
          const lockedScore = lockedObj.scoreSmooth || 0;
          const bestScore = best.scoreSmooth || 0;
          if (bestScore - lockedScore >= 8) S.locked = best.symbol;
        }
        // ç½®é ‚ï¼šæŠŠ locked æ”¾åœ¨ç¬¬ä¸€
        top = top.sort((a,b) => (a.symbol === S.locked ? -1 : b.symbol === S.locked ? 1 : (b.scoreSmooth - a.scoreSmooth)));
      }

      $("readyN").innerText = String(S.symbols.size);
      return top;
    }

    /***********************
     * RENDER
     ***********************/
    function render() {
      const top5 = pickTop5();
      panel.innerHTML = "";

      for (let idx=0; idx<top5.length; idx++) {
        const st = top5[idx];
        const b = stageBadge(st.stage);

        const isLocked = (st.symbol === S.locked);
        const rankBadge = idx === 0 ? "ğŸ† ç¬¬1å" : ("ç¬¬" + (idx+1) + "å");

        const ai = st.ai || {};
        const aiHas = !!ai.obj;
        const aiTxt = aiHas ? formatAIChinese(ai.obj) : (ai.lastErr ? ("ï¼ˆAIéŒ¯èª¤ï¼‰" + ai.lastErr) : "å°šæœªåˆ†æï¼šæŒ‰å³ä¸Šã€Analyzeã€‘æˆ–ã€Analyze Top3ã€‘");

        const aiMeta = [];
        if (ai.lastAt) aiMeta.push("AI@" + new Date(ai.lastAt).toLocaleTimeString("zh-TW",{hour12:false}));
        if (ai.cooldownUntil && Date.now() < ai.cooldownUntil) aiMeta.push("å†·å»ä¸­");
        if (Date.now() < S.globalCooldownUntil) aiMeta.push("å…¨ç«™å†·å»(429)");

        const card = document.createElement("div");
        card.className = `card rounded-xl p-4 ${isLocked ? "lock" : ""}`;

        card.innerHTML = `
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div class="flex items-center gap-2">
              <div class="text-white font-black text-lg">${st.symbol}</div>
              <span class="badge ${b.cls}">${b.text}</span>
              ${isLocked ? `<span class="badge border-emerald-500/50 text-emerald-300 bg-emerald-500/10">âœ… æœ€å¼·é–å®š</span>` : ``}
              <span class="badge">${rankBadge}</span>
              <span class="badge mono">score ${fmtNum(st.scoreSmooth,2)}</span>
            </div>

            <div class="flex items-center gap-2">
              <button class="btn2 px-3 py-2 rounded text-[12px] font-bold" data-act="analyze" data-sym="${st.symbol}">Analyzeï¼ˆGeminiï¼‰</button>
            </div>
          </div>

          <div class="mt-2 small">ç†ç”±ï¼š${st.stageReason || "-"}</div>

          <div class="mt-3 grid2 gap-3">
            <!-- LEFT: metrics -->
            <div class="grid3">
              ${metric("æ³¢å‹•/é‡ç•°å¸¸ Z", fmtNum(st.last.volZ,2))}
              ${metric("5åˆ†é˜æ¼²è·Œ", fmtPct(st.last.ret5m,2))}
              ${metric("è³‡é‡‘è²»ç‡(%)", fmtNum(st.last.fund,2))}
              ${metric("æº¢åƒ¹(%)", fmtNum(st.last.premium,3))}
              ${metric("ä¸»å‹•è²·å…¥æ¯”ä¾‹(5m)", st.last.activeRatio5m!==null?fmtNum(st.last.activeRatio5m,3):"-")}
              ${metric("ä¸»å‹•è²·å…¥å·®é¡(5m,é‡‘é¡)", st.last.activeDiff5m!==null?fmtNum(st.last.activeDiff5m,0):"-")}
              ${metric("ä¸»å‹•è²·å…¥æ¯”ä¾‹(4h)", st.last.activeRatio4h!==null?fmtNum(st.last.activeRatio4h,3):"-")}
              ${metric("ä¸»å‹•è²·å…¥å·®é¡(4h,é‡‘é¡)", st.last.activeDiff4h!==null?fmtNum(st.last.activeDiff4h,0):"-")}
              ${metric("OI è®ŠåŒ–(5m)", st.last.oi5mChg!==null?fmtNum(st.last.oi5mChg,2):"-")}
              ${metric("OI ç•°å¸¸ Z(5m)", fmtNum(st.last.oiZ5,2))}
              ${metric("OI è®ŠåŒ–(4h)", st.last.oi4hChg!==null?fmtNum(st.last.oi4hChg,2):"-")}
              ${metric("è¶¨å‹¢(EMA20>EMA50 ä¸” åƒ¹åœ¨EMA20ä¸Š)", st.last.trendOk ? "âœ…" : "â€”")}
              ${metric("å€é–“é«˜(20)", fmtNum(st.last.range20High,6))}
              ${metric("å€é–“ä½(20)", fmtNum(st.last.range20Low,6))}
              ${metric("ç¾åƒ¹", fmtNum(st.last.price,6))}
            </div>

            <!-- RIGHT: AI -->
            <div class="aiBox rounded-xl p-3">
              <div class="flex items-center justify-between">
                <div class="aiTitle">AI åˆ¤è®€ï¼ˆä¸­æ–‡ï¼‰</div>
                <div class="small mono">${aiMeta.join(" Â· ")}</div>
              </div>
              <div class="mt-2 text-[12px] leading-relaxed whitespace-pre-wrap">${aiTxt}</div>
            </div>
          </div>
        `;

        panel.appendChild(card);
      }

      // äº‹ä»¶ç¶å®š
      panel.querySelectorAll("button[data-act='analyze']").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const sym = btn.getAttribute("data-sym");
          await analyzeOne(sym, true);
          render();
        });
      });
    }

    function metric(k, v) {
      return `
        <div class="pill rounded-lg px-3 py-2">
          <div class="k">${k}</div>
          <div class="v mono">${v}</div>
        </div>
      `;
    }

    /***********************
     * GEMINI
     ***********************/
    function buildPromptForGemini(st) {
      // åªä¸Ÿç²¾ç°¡æ‘˜è¦ï¼ˆé¿å… token çˆ†ï¼‰
      // è¦æ±‚ï¼šè¼¸å‡ºã€Œåªåšå¤šã€çš„åˆ¤æ–·ã€é è¨ˆå¹¾åˆ†é˜å…§è¡¨æ…‹å€é–“ã€é€²å ´/åœæ/æ­¢ç›ˆã€ä¿¡å¿ƒåˆ†æ•¸ã€ç‹€æ…‹
      const L = st.last;

      const summary = {
        symbol: st.symbol,
        onlyLong: true,
        stage: st.stage,
        stageReason: st.stageReason,
        price: L.price,
        ret5m_pct: L.ret5m,
        volZ_5m: L.volZ,
        funding_pct: L.fund,
        premium_pct: L.premium,
        activeBuyRatio_5m: L.activeRatio5m,
        activeBuyDiff_5m_quote: L.activeDiff5m,
        activeBuyRatio_4h: L.activeRatio4h,
        activeBuyDiff_4h_quote: L.activeDiff4h,
        oi_now: L.oiNow,
        oi_change_5m: L.oi5mChg,
        oi_change_4h: L.oi4hChg,
        oiZ_5m: L.oiZ5,
        trendOk: !!L.trendOk,
        range20_high: L.range20High,
        range20_low: L.range20Low,
        antiChase_ret5m_max: CHASE_RET5M_MAX
      };

      return `
ä½ æ˜¯åˆç´„çŸ­ç·šã€Œåªåšå¤šã€çš„ç›¤å‹¢åˆ¤è®€å¼•æ“ã€‚è«‹æ ¹æ“šæˆ‘çµ¦çš„ç²¾ç°¡æ•¸æ“šï¼Œè¼¸å‡ºã€Œåš´æ ¼ JSONã€ä¸”åªèƒ½å› JSONï¼ˆä¸è¦ä»»ä½•å¤šé¤˜æ–‡å­—ã€ä¸è¦ markdownï¼‰ã€‚

ä»»å‹™ï¼šåˆ¤æ–·é€™å€‹å¹£åœ¨æœªä¾† 5~10 åˆ†é˜å…§æ˜¯å¦ã€Œå¯èƒ½å‘ä¸Šè¡¨æ…‹ã€ï¼Œä¸¦çµ¦å‡ºï¼š
1) åšå¤š/è§€æœ›/ä¸åš çš„æ–¹å‘ï¼ˆåªåšå¤šï¼Œä¸æä¾›åšç©ºç­–ç•¥ï¼‰
2) ä¿¡å¿ƒ 0~100
3) ç•¶å‰ç‹€æ…‹ï¼ˆè“„å‹¢/é»ç«/è§¸ç™¼/ç„¡ï¼‰
4) é è¨ˆè¡¨æ…‹æ™‚é–“å€é–“ï¼ˆåˆ†é˜ min/maxï¼‰
5) é€²å ´æ–¹å¼èˆ‡å€é–“ï¼ˆå¸‚åƒ¹/é™åƒ¹ã€entry_low/entry_highï¼‰
6) åœæï¼ˆstopï¼‰
7) åˆ†æ‰¹æ­¢ç›ˆï¼ˆtakeProfit é™£åˆ—ï¼‰
8) å¤±æ•ˆæ¢ä»¶ï¼ˆinvalidations é™£åˆ—ï¼‰
9) ç†ç”±è¦é»ï¼ˆreasons é™£åˆ—ï¼ŒçŸ­å¥ï¼‰

æ³¨æ„ï¼šè¦ anti-chaseï¼šè‹¥å·²å™´å¤ªé«˜æˆ– funding éç†±ï¼Œè¦å‚¾å‘ã€Œè§€æœ›ã€ä¸¦æŠŠåŸå› å¯«åœ¨ invalidations/é¢¨éšªã€‚
è«‹å‹™å¿…æŠŠç¼ºå¤±æ¬„ä½å¡« "-"ï¼Œä¸è¦ç•™ç©ºï¼Œä¸è¦è¼¸å‡º nullã€‚

è¼¸å…¥æ•¸æ“š(JSON)ï¼š
${JSON.stringify(summary)}
`.trim();
    }

    async function geminiGenerateJSON(prompt) {
      // å†·å»åˆ¤æ–·
      const now = Date.now();
      if (now < S.globalCooldownUntil) {
        return { ok:false, status:429, err:"å…¨ç«™å†·å»ä¸­ï¼ˆå‰›å‰› 429ï¼‰" };
      }
      if (!S.key) return { ok:false, status:401, err:"æœªè¨­å®š Gemini Key" };

      // å…¨åŸŸé–“éš”
      const gap = now - S.lastGeminiAt;
      if (gap < GLOBAL_MIN_GAP_MS) {
        await new Promise(r=>setTimeout(r, GLOBAL_MIN_GAP_MS - gap));
      }

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent`;
      const body = {
        // REST å¯ç”¨ system_instructionï¼ˆå®˜æ–¹ä¾‹å­ï¼‰ :contentReference[oaicite:2]{index=2}
        system_instruction: { parts: [{ text: "ä½ åªè¼¸å‡º JSONã€‚åªèƒ½å› JSONã€‚ä¸å¯åŠ ä»»ä½•å¤šé¤˜æ–‡å­—ã€‚" }] },
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          maxOutputTokens: MAX_OUTPUT_TOKENS,
          temperature: 0.25,
          responseMimeType: "application/json" // å®˜æ–¹ JSON mode åƒæ•¸ :contentReference[oaicite:3]{index=3}
        }
      };

      S.lastGeminiAt = Date.now();

      const r = await fetch(url, {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          "x-goog-api-key": S.key, // å®˜æ–¹ï¼šx-goog-api-key header :contentReference[oaicite:4]{index=4}
        },
        body: JSON.stringify(body)
      });

      if (r.status === 429) {
        S.globalCooldownUntil = Date.now() + COOLDOWN_ON_429_MS;
        updateKeyUi();
      }

      const txt = await r.text();
      let data = null;
      try { data = JSON.parse(txt); } catch(e) { data = { _raw: txt }; }

      if (!r.ok) {
        return { ok:false, status:r.status, err: (data && data.error && data.error.message) ? data.error.message : txt };
      }

      const out = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!out) {
        return { ok:false, status:500, err:"Gemini å›å‚³æ ¼å¼ç•°å¸¸ï¼šæ‰¾ä¸åˆ° candidates[0].content.parts[0].text" };
      }

      // ç›¡å¯èƒ½æŠ½å‡º JSON
      const parsed = safeParseJSON(out);
      if (!parsed) {
        return { ok:false, status:200, err:"Gemini æ²’å›æœ‰æ•ˆ JSONï¼ˆå·²è¦æ±‚ JSON modeï¼‰", raw: out };
      }
      return { ok:true, status:200, obj: parsed };
    }

    function safeParseJSON(s) {
      if (!s) return null;
      // è‹¥ Gemini ä»åŒ…äº†é›œè¨Šï¼ŒæŠ“ç¬¬ä¸€å€‹ { åˆ°æœ€å¾Œä¸€å€‹ }
      const i = s.indexOf("{");
      const j = s.lastIndexOf("}");
      if (i >= 0 && j > i) {
        const sub = s.slice(i, j+1);
        try { return JSON.parse(sub); } catch(e) {}
      }
      try { return JSON.parse(s); } catch(e) {}
      return null;
    }

    function normalizeAI(obj, fallbackSymbol) {
      // ä¿è­‰æ¬„ä½é½Šå…¨ï¼ˆä½ ä¹‹å‰æŠ±æ€¨ä¸€å †æ²’é¡¯ç¤ºï¼Œå°±æ˜¯é€™è£¡åšä¿åº•ï¼‰
      const o = obj || {};
      const get = (k, d="-") => (o[k]===undefined || o[k]===null || o[k]==="") ? d : o[k];

      return {
        symbol: get("symbol", fallbackSymbol),
        æ–¹å‘: get("æ–¹å‘", get("bias","è§€æœ›")),
        ä¿¡å¿ƒ: get("ä¿¡å¿ƒ", get("confidence", 0)),
        ç‹€æ…‹: get("ç‹€æ…‹", get("state","-")),
        å‹æ…‹: get("å‹æ…‹", get("pattern","-")),
        é è¨ˆè¡¨æ…‹: get("é è¨ˆè¡¨æ…‹", get("eta","-")),
        é€²å ´: get("é€²å ´", get("entry","-")),
        åœæ: get("åœæ", get("stop","-")),
        æ­¢ç›ˆ: get("æ­¢ç›ˆ", get("takeProfit", [])),
        å¤±æ•ˆæ¢ä»¶: get("å¤±æ•ˆæ¢ä»¶", get("invalidations", [])),
        ç†ç”±è¦é»: get("ç†ç”±è¦é»", get("reasons", [])),
        é¢¨éšªæé†’: get("é¢¨éšªæé†’", get("risks", [])),
      };
    }

    function formatAIChinese(obj) {
      const o = normalizeAI(obj, "-");
      const eta = (typeof o.é è¨ˆè¡¨æ…‹ === "object" && o.é è¨ˆè¡¨æ…‹) ? `${o.é è¨ˆè¡¨æ…‹.min ?? "-"}~${o.é è¨ˆè¡¨æ…‹.max ?? "-"} åˆ†é˜` : String(o.é è¨ˆè¡¨æ…‹);

      const tp = Array.isArray(o.æ­¢ç›ˆ) ? o.æ­¢ç›ˆ : [];
      const inv = Array.isArray(o.å¤±æ•ˆæ¢ä»¶) ? o.å¤±æ•ˆæ¢ä»¶ : [];
      const rs = Array.isArray(o.ç†ç”±è¦é») ? o.ç†ç”±è¦é» : [];
      const rk = Array.isArray(o.é¢¨éšªæé†’) ? o.é¢¨éšªæé†’ : [];

      return [
        `æ–¹å‘ï¼š${o.æ–¹å‘}ã€€|ã€€ä¿¡å¿ƒï¼š${o.ä¿¡å¿ƒ}/100`,
        `ç‹€æ…‹ï¼š${o.ç‹€æ…‹}ã€€|ã€€å‹æ…‹ï¼š${o.å‹æ…‹}`,
        `é è¨ˆè¡¨æ…‹ï¼š${eta}`,
        `é€²å ´ï¼š${typeof o.é€²å ´ === "object" ? JSON.stringify(o.é€²å ´) : o.é€²å ´}`,
        `åœæï¼š${typeof o.åœæ === "object" ? JSON.stringify(o.åœæ) : o.åœæ}`,
        `æ­¢ç›ˆï¼š${tp.length ? tp.join(" / ") : "-"}`,
        `å¤±æ•ˆæ¢ä»¶ï¼š${inv.length ? inv.join(" / ") : "-"}`,
        `ç†ç”±ï¼š${rs.length ? ("\n- " + rs.join("\n- ")) : "-"}`,
        rk.length ? (`é¢¨éšªï¼š\n- ${rk.join("\n- ")}`) : ""
      ].filter(Boolean).join("\n");
    }

    async function analyzeOne(symbol, manual=false) {
      const st = S.symbols.get(symbol);
      if (!st) return;

      if (!S.key) {
        st.ai.lastErr = "æœªè¨­å®š Gemini Key";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        updateKeyUi();
        return;
      }

      // per-symbol cooldownï¼ˆæ‰‹å‹•ä¹Ÿè¦å†·å»ï¼Œé¿å…ç‹‚é»ï¼‰
      const now = Date.now();
      if (st.ai.cooldownUntil && now < st.ai.cooldownUntil) {
        st.ai.lastErr = "å†·å»ä¸­ï¼Œç¨å¾Œå†è©¦";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        return;
      }
      if (st.ai.lastAt && (now - st.ai.lastAt < PER_SYMBOL_COOLDOWN_MS)) {
        st.ai.lastErr = "åŒå¹£å†·å»ä¸­ï¼ˆ60sï¼‰";
        st.ai.lastOk = false;
        S.symbols.set(symbol, st);
        return;
      }

      // Auto æ¨¡å¼ï¼šåªåœ¨ ğŸŸ§/ğŸŸ© æ‰æ‰“ï¼›Manualï¼šä¸ç®¡æ¢ä»¶
      if (!manual) {
        if (!(st.stage === "IGNITE" || st.stage === "CONFIRM")) return;
      }

      st.ai.lastErr = "";
      st.ai.lastOk = false;
      st.ai.obj = null;
      S.symbols.set(symbol, st);
      render();

      setStatus(`Gemini é€å‡ºï¼š${symbol} ...`);
      updateKeyUi();

      const prompt = buildPromptForGemini(st);
      const res = await geminiGenerateJSON(prompt);

      if (!res.ok) {
        st.ai.lastAt = Date.now();
        st.ai.lastOk = false;
        st.ai.lastErr = `HTTP ${res.status}: ${res.err || "error"}`;
        st.ai.cooldownUntil = Date.now() + 8000; // å°å†·å»é¿å…é€£é»
        S.symbols.set(symbol, st);
        setStatus(`Gemini FAILï¼š${symbol}ï¼ˆ${res.status}ï¼‰`);
        if (res.status === 429) setStatus(`Gemini 429ï¼šå·²é€²å…¥å…¨ç«™å†·å» ${Math.round(COOLDOWN_ON_429_MS/60000)} åˆ†é˜`);
        updateKeyUi();
        return;
      }

      st.ai.lastAt = Date.now();
      st.ai.lastOk = true;
      st.ai.lastErr = "";
      st.ai.obj = normalizeAI(res.obj, symbol);
      st.ai.cooldownUntil = Date.now() + 2000;
      S.symbols.set(symbol, st);

      // key status
      S.keyOk = true;
      S.keyLastOkAt = Date.now();
      setStatus(`Gemini OKï¼š${symbol}`);
      updateKeyUi();
    }

    async function analyzeTop3(manual=false) {
      const top = pickTop5().slice(0, TOPK_ANALYZE);
      for (const st of top) {
        await analyzeOne(st.symbol, true); // ä½ è¦æ‰‹å‹•ä¹Ÿèƒ½æ‰“ï¼šé€™è£¡ç•¶æˆ manual=true
        await new Promise(r=>setTimeout(r, 200)); // å¾®å°é–“éš”
      }
      render();
    }

    async function testGemini() {
      if (!S.key) { setStatus("å…ˆè²¼ Key å† Test"); updateKeyUi(); return; }

      setStatus("Test Gemini ...");
      const prompt = `åªå› JSONï¼š{"ok":true,"msg":"pong"}ï¼ˆåªèƒ½ JSONï¼Œä¸è¦ä»»ä½•å­—ï¼‰`;
      const res = await geminiGenerateJSON(prompt);

      if (!res.ok) {
        setStatus(`Test FAILï¼ˆHTTP ${res.status}ï¼‰ï¼š${res.err || ""}`);
        updateKeyUi();
        return;
      }

      S.keyOk = true;
      S.keyLastOkAt = Date.now();
    
      setStatus("Test OKï¼šGemini å¯ç”¨");
      updateKeyUi();
      alert("Test OKï¼šGemini å¯ç”¨ï¼ˆçœ‹ console/network ä¹Ÿæœƒæœ‰ requestï¼‰");
    }

    /***********************
     * LOOPS
     ***********************/
    async function scanTick() {
      if (!S.universe.length) return;

      // round-robinï¼šæ¯æ¬¡åªæ›´æ–°ä¸€å°æ‰¹ï¼Œé¿å… Binance æ‰“çˆ†
      const BATCH = 8;
      const batch = [];
      for (let i=0;i<BATCH;i++) {
        const sym = S.universe[(S.rrIdx + i) % S.universe.length];
        batch.push(sym);
      }
      S.rrIdx = (S.rrIdx + BATCH) % S.universe.length;

      await Promise.all(batch.map(sym => updateSymbol(sym)));

      $("lastUpdate").innerText = nowHHMMSS();
      updateKeyUi();
      render();
    }

    function startAutoGemini() {
      setInterval(async ()=>{
        if (!$("autoToggle").checked) return;
        if (!S.key) return;
        if (Date.now() < S.globalCooldownUntil) return;

        // åªåœ¨ top5 å·²ç¶“æœ‰ 5 æ”¯ï¼Œä¸”è‡³å°‘ä¸€æ”¯åœ¨ ğŸŸ§/ğŸŸ© æ‰è‡ªå‹•æ‰“
        const top5 = pickTop5();
        if (top5.length < 5) return;
        const hot = top5.filter(x => x.stage === "IGNITE" || x.stage === "CONFIRM");
        if (!hot.length) return;

        // åªæ‰“ Top3
        setStatus("Auto Geminiï¼šTop3 ...");
        for (const st of top5.slice(0, TOPK_ANALYZE)) {
          await analyzeOne(st.symbol, false); // auto æ¨¡å¼ï¼šå…§éƒ¨æœƒ gate åªæœ‰ ğŸŸ§/ğŸŸ© æ‰é€
        }
        render();
      }, AUTO_INTERVAL_MS);
    }

    /***********************
     * EVENTS
     ***********************/
    $("btnSaveKey").addEventListener("click", saveKeyFromInput);
    $("btnClearKey").addEventListener("click", clearKey);
    $("btnTestGemini").addEventListener("click", testGemini);
    $("btnAnalyzeTop").addEventListener("click", ()=>analyzeTop3(true));
    $("btnReset").addEventListener("click", ()=>{
      S.symbols.clear();
      S.locked = null;
      setStatus("Reset done");
      render();
    });

    /***********************
     * BOOT
     ***********************/
    (async function boot(){
      loadKey();
      setStatus("Booting ...");
      await refreshUniverse();
      // å…ˆè·‘ä¸€æ¬¡ scan è®“ç•«é¢æœ‰æ±è¥¿
      await scanTick();
      // é€±æœŸæƒæ
      setInterval(scanTick, SCAN_INTERVAL_MS);
      // Auto Gemini
      startAutoGemini();
      setStatus("Running");
    })();
  </script>
</body>
</html>
